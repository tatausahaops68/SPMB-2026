<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPMB Online 2025 | Sekolah Unggulan</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

<style>
    /* ================= VARIABLE & RESET ================= */
    :root {
      /* Warna Utama */
      --primary: #2563eb; /* Royal Blue */
      --primary-dark: #1e40af; /* Navy Blue */
      --secondary: #64748b; /* Slate Grey */
      --bg-body: #f8fafc; /* Light Background */
      
      /* Warna Navbar Tetap (Public) */
      --navbar-bg: rgb(26, 25, 103);

      /* Admin Theme Variables */
      --sidebar-width: 280px;
      --sidebar-bg: #151521; /* Gelap Pekat */
      --sidebar-text: #9ca3af; /* Teks Sidebar */
      --sidebar-active: #3b82f6; /* Active Color */
      --admin-bg: #f8fafc; /* Background Admin Terang */
      
      /* UI Utils */
      --card-radius: 16px;
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      color: #334155;
      overflow-x: hidden;
      line-height: 1.6;
      background-color: #f8fafc; 
      position: relative;
    }

    /* [OPTIMASI] Background Layer 1 */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100vh;
      z-index: -1;
      background: linear-gradient(rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.6)),
        url('https://images.unsplash.com/photo-1541339907198-e08756dedf3f?q=80&w=1920&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      will-change: transform; 
      transform: translateZ(0);
    }

    /* ================= 1. NAVBAR PUBLIK ================= */
    
    .public-navbar {
      background: var(--navbar-bg) !important;
      padding: 1rem 0;
      transition: padding 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
      border-bottom: 2px solid #0f172a !important;
      position: fixed; top: 0; width: 100%;
      z-index: 9999 !important; 
      transform: translate3d(0, 0, 0);
      will-change: padding;
    }

    /* ATURAN DESKTOP: Pastikan menu tampil horizontal */
    @media (min-width: 992px) {
      .public-navbar .navbar-collapse {
          display: flex !important;
          flex-basis: auto;
          visibility: visible !important;
          opacity: 1 !important;
          height: auto !important; /* PENTING: Agar tidak tinggi 0 */
      }
      .public-navbar .navbar-toggler {
          display: none !important;
      }
      .public-navbar .navbar-nav {
          flex-direction: row; 
          align-items: center;
      }
    }

    .public-navbar.scrolled {
      padding: 0.7rem 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    .public-navbar .navbar-brand {
      font-weight: 800; font-size: 1.35rem; color: #ffffff !important;
      display: flex; align-items: center; gap: 12px;
    }
    
    .public-navbar .nav-link {
      color: rgba(255, 255, 255, 0.85) !important;
      font-weight: 500; margin-left: 5px; padding: 8px 16px !important;
      border-radius: 8px; transition: all 0.3s ease;
    }
    
    .public-navbar .nav-link:hover, 
    .public-navbar .nav-link.active { 
      color: #ffffff !important;
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .btn-nav {
      background-color: #ffffff; color: var(--navbar-bg) !important;
      border-radius: 50px; padding: 10px 24px; font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); border: 2px solid transparent;
    }
    .btn-nav:hover {
      background-color: transparent; color: #ffffff !important;
      border-color: #ffffff; transform: translateY(-2px);
    }

    .btn-admin-nav {
      border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.9);
      border-radius: 50px; padding: 8px 20px; font-size: 0.9rem;
      transition: 0.3s; background: rgba(255,255,255,0.05);
    }
    .btn-admin-nav:hover {
      background: rgba(255,255,255,0.25); color: white; border-color: white;
    }

    .public-navbar .navbar-toggler {
      border: none; padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1); border-radius: 8px;
    }
    .public-navbar .navbar-toggler i { color: white !important; }

    @media (max-width: 991px) {
      .public-navbar .navbar-collapse {
        background: var(--navbar-bg);
        padding: 20px; border-radius: 16px; margin-top: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.15);
      }
      .public-navbar .nav-link { margin-left: 0; padding: 12px 16px; }
      .btn-nav, .btn-admin-nav { width: 100%; margin-top: 10px; text-align: center; }
    }


    /* ================= 2. MAIN WRAPPER ================= */
    
    .main-wrapper {
      width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0;
      background: rgba(255, 255, 255, 0.85);
      margin-top: 0; padding-top: 80px; position: relative; z-index: 5;
    }

    .hero-section, #alur, #daftar, #status {
      background: transparent !important; box-shadow: none !important;
      margin: 0 !important; padding: 80px 5% !important;      
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .hero-section > div, #alur > div, #daftar > div, #status > div {
        max-width: 1200px; margin: 0 auto;
    }
    .hero-bg-decoration { display: none; }


    /* ================= 3. HERO SECTION ================= */

    .hero-section {
      text-align: left; padding-top: 120px !important; padding-bottom: 100px !important;
      display: flex; align-items: center;
    }
    .hero-section .row { width: 100%; }

    .hero-badge {
      display: inline-flex; align-items: center;
      background: rgba(37, 99, 235, 0.1); color: var(--primary);
      font-size: 0.85rem; font-weight: 700;
      padding: 8px 16px; border-radius: 50px; margin-bottom: 24px;
    }
    .hero-title {
      font-size: 3.5rem; font-weight: 800; line-height: 1.2; color: #1e293b;
      margin-bottom: 20px; letter-spacing: -1px;
    }
    .hero-desc {
      font-size: 1.15rem; color: #475569; max-width: 90%; margin-bottom: 35px;
    }

    .hero-img {
      animation: floatImage 4s ease-in-out infinite;
      border-radius: 20px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); 
      max-width: 90%;
    }
    @keyframes floatImage {
      0% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0); }
    }


    /* ================= 4. GENERAL CONTENT STYLING ================= */

    .clean-card, .step-item, .stat-card, .card {
      border: 1px solid #94a3b8 !important;
    }
    .clean-card:hover, .step-item:hover, .stat-card:hover {
      border-color: var(--primary) !important;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .btn-primary-custom {
      background: var(--primary); color: white;
      padding: 14px 32px; border-radius: 12px; font-weight: 600; border: none;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: all 0.3s;
    }
    .btn-primary-custom:hover {
      background: var(--primary-dark); transform: translateY(-2px);
    }
    .btn-outline-custom {
      background: transparent; color: var(--secondary);
      border: 1px solid #cbd5e1; padding: 14px 32px; border-radius: 12px;
      font-weight: 600; margin-left: 10px; transition: all 0.3s;
    }
    .btn-outline-custom:hover {
      border-color: var(--primary); color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .step-item {
      text-align: center; padding: 30px 20px;
      background: #ffffff; border-radius: 16px; transition: 0.3s; height: 100%;
    }
    .step-icon-box {
      width: 60px; height: 60px; background: #eff6ff; color: var(--primary);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem; margin: 0 auto 20px;
    }

    .clean-card {
      background: #ffffff; border-radius: 20px;
      padding: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .section-title { font-weight: 800; color: #0f172a; margin-bottom: 10px; font-size: 2.5rem; }
    .section-subtitle { color: var(--secondary); font-size: 1.1rem; }

    .form-group { margin-bottom: 1.5rem; text-align: left; }
    .form-label { font-size: 0.9rem; font-weight: 600; color: #334155; margin-bottom: 8px; }
    .form-control, .form-select {
      background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 10px;
      padding: 12px 16px; font-size: 1rem; color: #1e293b;
    }
    .form-control:focus, .form-select:focus {
      background: #fff; border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); outline: none;
    }

    .upload-box {
      border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer;
      background: #f8fafc; transition: 0.3s;
    }
    .upload-box:hover { border-color: var(--primary); background: #eff6ff; }
    .upload-icon { font-size: 1.8rem; color: #94a3b8; margin-bottom: 10px; }

    footer { 
      background: #0f172a; color: #94a3b8; 
      padding: 80px 5% 40px; margin-top: 0; position: relative; z-index: 10;
    }
    footer > .container { max-width: 1200px; } 
    footer h5 { color: white; font-weight: 700; margin-bottom: 20px; }
    footer a { color: #94a3b8; text-decoration: none; transition: 0.2s; }
    footer a:hover { color: white; }


    /* ================= 5. ADMIN DASHBOARD ================= */
    
    #admin-section {
      display: none; min-height: 100vh;
      background-color: var(--admin-bg); font-family: 'Inter', sans-serif;
      position: relative;
    }
    #admin-section::before {
      content: ''; position: absolute; top: -100px; right: -100px;
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, transparent 70%);
      z-index: 0; pointer-events: none;
    }
    #wrapper { display: flex; width: 100%; align-items: stretch; overflow-x: hidden; position: relative; z-index: 1;}

    #sidebar-wrapper {
      min-width: var(--sidebar-width); max-width: var(--sidebar-width);
      background: var(--sidebar-bg); color: var(--sidebar-text);
      position: fixed; height: 100vh; z-index: 1000;
      display: flex; flex-direction: column; padding: 25px 20px;
      overflow-y: auto; border-right: none; box-shadow: 10px 0 30px rgba(0,0,0,0.03);
    }

    .sidebar-brand { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; padding: 0 5px; }
    .brand-icon {
      width: 36px; height: 36px; background: #3b82f6; border-radius: 10px;
      display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem;
    }
    .brand-text { color: #ffffff; font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px; }

    .sidebar-profile-card {
      background: #1e1e2d; border-radius: 16px; padding: 15px;
      display: flex; align-items: center; gap: 12px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.03);
    }
    .profile-img {
      width: 40px; height: 40px; background: #3b82f6; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1rem;
    }
    .profile-info h6 { color: white; font-size: 0.9rem; margin: 0; font-weight: 600; }
    .profile-info span {
      font-size: 0.7rem; color: #3b82f6; background: rgba(59, 130, 246, 0.1);
      padding: 2px 8px; border-radius: 4px; font-weight: 600;
    }

    .menu-label {
      font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 1px;
      margin-bottom: 10px; padding-left: 10px;
    }
    .sidebar-menu { display: flex; flex-direction: column; gap: 5px; }

    .menu-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #9ca3af; text-decoration: none;
      border-radius: 12px; font-weight: 500; font-size: 0.95rem; transition: all 0.3s ease;
    }
    .menu-item i { width: 20px; text-align: center; font-size: 1.1rem; }
    .menu-item:hover { background: rgba(255,255,255,0.05); color: #ffffff; }
    .menu-item.active { background: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .sidebar-footer { margin-top: auto; text-align: center; font-size: 0.75rem; color: #4b5563; padding-top: 20px; }

    #page-content-wrapper {
      width: 100%; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column;
    }
    .admin-navbar {
      background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.4); padding: 1rem 2.5rem;
      position: sticky; top: 0; z-index: 900; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
    }
    .admin-title { font-weight: 700; color: #1e293b; font-size: 1.2rem; }
    .admin-subtitle { font-size: 0.85rem; color: #64748b; font-weight: 500; }

    .dashboard-card {
      background: #ffffff; border-radius: 20px; padding: 25px;
      box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid rgba(241, 245, 249, 1);
      transition: transform 0.3s ease, box-shadow 0.3s ease; height: 100%; position: relative; overflow: hidden;
    }
    .dashboard-card:hover {
      transform: translateY(-5px); box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1); border-color: #e2e8f0;
    }
    .card-icon-bg {
      width: 50px; height: 50px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px;
    }
    .icon-blue { background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); color: #0284c7; }
    .icon-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #16a34a; }
    .icon-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #ea580c; }
    
    .card-label { font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    .card-value { font-size: 2.2rem; font-weight: 800; color: #0f172a; margin: 5px 0; line-height: 1; }
    .card-trend { font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 5px; }
    .trend-up { color: #10b981; }

    .modern-table-container { background: transparent; }
    .table-responsive { overflow-x: auto; }
    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
    .modern-table thead th {
      font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;
      padding: 0 20px 10px 20px; border: none; background: transparent;
    }
    .modern-table tbody tr {
      background: #ffffff; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.03); transition: all 0.2s;
    }
    .modern-table tbody tr:hover {
      transform: scale(1.005); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08); z-index: 10; position: relative;
    }
    .modern-table td {
      padding: 20px; vertical-align: middle; border-top: 1px solid transparent; border-bottom: 1px solid transparent;
    }
    .modern-table td:first-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
    .modern-table td:last-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

    .user-cell { display: flex; align-items: center; gap: 12px; }
    .user-cell-avatar { width: 40px; height: 40px; background: #f1f5f9; color: #475569; border-radius: 10px;
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; }
    .user-cell-info h6 { margin: 0; font-weight: 700; color: #1e293b; font-size: 0.95rem; }
    .user-cell-info span { font-size: 0.8rem; color: #64748b; }

    .status-badge { padding: 6px 14px; border-radius: 30px; font-size: 0.75rem;
      font-weight: 700; letter-spacing: 0.3px; display: inline-flex; align-items: center; gap: 6px; }
    .status-success { background: #dcfce7; color: #15803d; }
    .status-warning { background: #fef9c3; color: #a16207; }
    .status-danger { background: #fee2e2; color: #b91c1c; }

    .builder-card { background: white; border-radius: 20px;
      box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); padding: 30px; }
    .builder-item { border: 1px solid #e2e8f0 !important;
      background: #f8fafc !important; border-radius: 12px !important; transition: 0.2s; }
    .builder-item:hover { background: #fff !important; border-color: #cbd5e1 !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

    /* Responsive General */
    @media (max-width: 991px) {
      .hero-section { text-align: center !important; display: block; }
      .hero-desc { margin: 0 auto 30px; }
      .d-flex.gap-3 { justify-content: center; }
      .hero-img { margin-top: 40px; }
      .hero-title { font-size: 2.5rem; }
      .hero-section, #alur, #daftar, #status { padding: 40px 20px !important; }
      
      /* Admin Mobile */
      #sidebar-wrapper { margin-left: calc(-1 * var(--sidebar-width)); }
      #page-content-wrapper { margin-left: 0; }
      #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
      .admin-navbar { padding: 1rem; }
      .dashboard-card { margin-bottom: 15px; }
    }

    /* Style untuk Dynamic Dropdown Builder */
    .dropdown-option-row {
        display: flex; align-items: center; gap: 8px; margin-bottom: 8px; animation: fadeIn 0.3s ease;
    }
    .dropdown-option-row input {
        flex-grow: 1; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 12px; font-size: 0.9rem;
    }
    .dropdown-option-row input:focus { border-color: #3b82f6; outline: none; }
    .btn-remove-opt {
        color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;
        width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .btn-remove-opt:hover { background: #ef4444; color: white; }
    .btn-add-opt {
        color: #2563eb; background: #eff6ff; border: 1px dashed #bfdbfe; border-radius: 8px;
        width: 100%; padding: 8px; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-add-opt:hover { background: #dbeafe; border-color: #3b82f6; }

    @media (min-width: 768px) {
      .col-md-one-fifth { flex: 0 0 auto; width: 20%; }
    }

    /* ================= 6. SIDEBAR COLLAPSE (DESKTOP) ================= */
    
    #sidebar-wrapper, #page-content-wrapper, .menu-item span, .brand-text { transition: all 0.3s ease; }
    @media (min-width: 992px) {
        #wrapper.desktop-collapsed #sidebar-wrapper { min-width: 80px; max-width: 80px; padding: 25px 10px; }
        #wrapper.desktop-collapsed #page-content-wrapper { margin-left: 80px; }
        #wrapper.desktop-collapsed .brand-text, #wrapper.desktop-collapsed .profile-info,
        #wrapper.desktop-collapsed .menu-label, #wrapper.desktop-collapsed .sidebar-footer,
        #wrapper.desktop-collapsed .menu-item span { display: none !important; opacity: 0; }
        #wrapper.desktop-collapsed .sidebar-brand { justify-content: center; padding: 0; margin-bottom: 20px; }
        #wrapper.desktop-collapsed .sidebar-profile-card { justify-content: center; padding: 10px 0; background: transparent; border: none; }
        #wrapper.desktop-collapsed .menu-item { justify-content: center; padding: 12px 0; }
        #wrapper.desktop-collapsed .menu-item i { margin: 0; font-size: 1.3rem; }
    }

    /* ================= 7. FIX NAVIGASI MOBILE (FINAL & BERSIH) ================= */
        
    /* 1. Paksa GPU Rendering agar animasi halus */
    .public-navbar .navbar-collapse {
        transform: translateZ(0); 
        -webkit-backface-visibility: hidden; 
        will-change: height, padding;
    }

    /* 2. Reset visibility untuk Desktop */
    .navbar-collapse.collapse {
        display: block; /* Default block agar tampil di desktop */
        visibility: visible !important;
    }

    /* 3. ATURAN KHUSUS MOBILE (< 992px) */
    @media (max-width: 991px) {
        
        /* Saat animasi berjalan (collapsing) */
        .navbar-collapse.collapsing {
            display: block !important; 
            visibility: visible !important;
            height: 0; overflow: hidden;
            transition: height 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        /* Saat menu tertutup (hanya di mobile) */
        .navbar-collapse.collapse:not(.show) {
            display: none !important;
        }

        /* Saat menu terbuka (hanya di mobile) */
        .navbar-collapse.collapse.show {
            display: block !important;
            visibility: visible !important;
            height: auto !important;
        }
    }

/* ================= SPA MODE (KUNCI AGAR TIDAK BISA SCROLL) ================= */

/* 1. Sembunyikan SEMUA section secara default */
.spa-section {
    display: none !important; /* Paksa hilang */
    min-height: 80vh; /* Agar footer tetap di bawah */
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

/* 2. Hanya tampilkan section yang punya class 'active-section' */
.spa-section.active-section {
    display: block !important; /* Paksa tampil */
    opacity: 1;
    animation: fadeInPage 0.5s ease-out;
}

/* Animasi Masuk */
@keyframes fadeInPage {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Penanda Menu Aktif di Navbar */
.nav-link.active-menu {
    color: #ffffff !important;
    background: rgba(255, 255, 255, 0.2);
    font-weight: 700;
    border-radius: 8px;
}
</style>

</head>
<body>

  <div id="public-section">

    <nav class="navbar navbar-expand-lg fixed-top public-navbar">
      <div class="container">
        <a class="navbar-brand" href="#" onclick="switchPage('beranda'); return false;">
          <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; overflow:hidden;">
            <? if (konfigurasi.logoUrl && konfigurasi.logoUrl.length > 10) { ?>
               <img src="<?= konfigurasi.logoUrl ?>" style="width:100%; height:100%; object-fit:cover;">
            <? } else { ?>
               <i class="fas fa-graduation-cap"></i>
            <? } ?>
          </div>
          <div style="display:flex; flex-direction:column; line-height:1.1;">
            <span><?= konfigurasi.appName ?></span>
            <span style="font-size:0.65rem; font-weight:400; opacity:0.7; letter-spacing:1px;"><?= konfigurasi.footerJudul ?></span>
          </div>
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <i class="fas fa-bars"></i>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item">
                <a class="nav-link active-menu" href="#" onclick="switchPage('beranda'); return false;">Beranda</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="switchPage('alur'); return false;">Alur Pendaftaran</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="switchPage('status'); return false;">Cek Status</a>
            </li>
            
            <li class="nav-item ms-lg-3 mt-2 mt-lg-0">
               <? if (konfigurasi.pendaftaranStatus !== 'ditutup') { ?>
                  <button class="btn btn-nav" onclick="switchPage('daftar')">
                    Daftar Sekarang <i class="fas fa-arrow-right ms-2" style="font-size:0.8em"></i>
                  </button>
               <? } ?>
            </li>
            
            <li class="nav-item ms-lg-2 mt-2 mt-lg-0">
              <button class="btn btn-admin-nav" onclick="showLoginModal()">
                <i class="fas fa-lock me-1"></i> Admin
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="main-wrapper container-fluid">

      <section id="beranda" class="hero-section spa-section active-section">
        <div class="row align-items-center">
          <div class="col-lg-6 mb-5 mb-lg-0 ps-lg-5" data-aos="fade-right">
            <div class="hero-badge">
              <i class="fas fa-check-circle me-2"></i> <?= konfigurasi.teksHero ?>
            </div>
            <h1 class="hero-title">
              <?= konfigurasi.heroBaris1 ?> <span style="color: var(--primary);"><?= konfigurasi.heroBaris2 ?></span>
            </h1>
            <p class="hero-desc">
              <?= konfigurasi.heroSubteks ?>
            </p>
            <div class="d-flex flex-wrap gap-3">
              <? if (konfigurasi.pendaftaranStatus === 'ditutup') { ?>
                  <button class="btn btn-secondary px-4 py-3 rounded-3" disabled style="cursor:not-allowed; font-weight:600;">
                    <i class="fas fa-lock me-2"></i> Pendaftaran Ditutup
                  </button>
              <? } else { ?>
                  <button class="btn-primary-custom" onclick="switchPage('daftar')">
                    Mulai Pendaftaran
                  </button>
              <? } ?>
              
              <button class="btn-outline-custom" onclick="switchPage('status')">
                <i class="fas fa-search me-2"></i>Cek Kelulusan
              </button>
            </div>
          </div>

          <div class="col-lg-6 text-center" data-aos="fade-left">
             <img src="<?= konfigurasi.heroImageUrl || 'https://img.freepik.com/free-vector/happy-students-with-backpacks-books_74855-5853.jpg' ?>" 
                 class="img-fluid hero-img" 
                 alt="Ilustrasi Sekolah"
                 style="mix-blend-mode: multiply; max-width: 90%;"> 
          </div>
        </div>
      </section>

      <section id="alur" class="spa-section">
        <div class="text-center mb-5" data-aos="fade-up">
          <h2 class="section-title">Alur Pendaftaran</h2>
          <p class="section-subtitle">Proses mudah dalam 4 langkah</p>
        </div>
        
        <div class="row g-4 justify-content-center">
          <div class="col-md-3" data-aos="fade-up" data-aos-delay="100">
            <div class="step-item">
              <div class="step-icon-box"><i class="far fa-file-alt"></i></div>
              <h5 class="fw-bold mb-2">1. <?= konfigurasi.alur1_judul ?></h5>
              <p class="text-muted small"><?= konfigurasi.alur1_desc ?></p>
            </div>
          </div>
          <div class="col-md-3" data-aos="fade-up" data-aos-delay="200">
            <div class="step-item">
              <div class="step-icon-box"><i class="far fa-folder-open"></i></div>
              <h5 class="fw-bold mb-2">2. <?= konfigurasi.alur2_judul ?></h5>
              <p class="text-muted small"><?= konfigurasi.alur2_desc ?></p>
            </div>
          </div>
          <div class="col-md-3" data-aos="fade-up" data-aos-delay="300">
            <div class="step-item">
              <div class="step-icon-box"><i class="far fa-clock"></i></div>
              <h5 class="fw-bold mb-2">3. <?= konfigurasi.alur3_judul ?></h5>
              <p class="text-muted small"><?= konfigurasi.alur3_desc ?></p>
            </div>
          </div>
          <div class="col-md-3" data-aos="fade-up" data-aos-delay="400">
            <div class="step-item">
              <div class="step-icon-box"><i class="far fa-check-circle"></i></div>
              <h5 class="fw-bold mb-2">4. <?= konfigurasi.alur4_judul ?></h5>
              <p class="text-muted small"><?= konfigurasi.alur4_desc ?></p>
            </div>
          </div>
        </div>
      </section>

      <section id="daftar" class="spa-section">
        <? if (konfigurasi.pendaftaranStatus === 'ditutup') { ?>
            <div class="container text-center py-5" data-aos="zoom-in">
                <div class="p-5 bg-slate-100 rounded-2xl border border-slate-200 inline-block">
                    <i class="fas fa-calendar-times text-4xl text-slate-400 mb-3"></i>
                    <h2 class="text-2xl font-bold text-slate-600">Mohon Maaf, Pendaftaran Sudah Ditutup.</h2>
                    <p class="text-slate-500">Silakan hubungi panitia untuk informasi lebih lanjut.</p>
                </div>
            </div>
        <? } else { ?>
            <div class="row justify-content-center">
              <div class="col-lg-10">
                <div class="clean-card" data-aos="zoom-in">
                  <div class="text-center mb-5">
                    <span style="background: #eff6ff; color: var(--primary); padding: 5px 15px; border-radius: 50px; font-weight: 600; font-size: 0.8rem;">FORMULIR ONLINE</span>
                    <h2 class="section-title mt-3">Isi Data Pendaftaran</h2>
                    <p class="section-subtitle">Pastikan data yang diinput valid sesuai dokumen asli.</p>
                  </div>

                  <form id="SPMBForm" onsubmit="handleDynamicSubmit(event)">
                     <div id="dynamicFormFields" class="row">
                       <div class="col-12 text-center py-5">
                          <div class="spinner-border text-primary" role="status"></div>
                          <p class="mt-2 text-muted">Memuat Formulir Pendaftaran...</p>
                       </div>
                     </div>

                    <div class="mt-4 text-center">
                      <button type="submit" class="btn-primary-custom px-5 py-3" style="font-size: 1.1rem;">
                        <i class="fas fa-paper-plane me-2"></i> Kirim Formulir Pendaftaran
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        <? } ?>
      </section>

      <section id="status" class="spa-section">
        <div class="row align-items-center justify-content-center">
          <div class="col-md-5 mb-4 mb-md-0" data-aos="fade-right">
            <h2 class="section-title">Cek Status Pendaftaran</h2>
            <p class="text-secondary">
              Sudah mendaftar? Silakan masukkan Kode Pendaftaran untuk melihat hasil verifikasi panitia.
            </p>
          </div>
          <div class="col-md-6" data-aos="fade-left">
            <div style="background: #fff; padding: 40px; border-radius: 20px; border: 1px solid #94a3b8; box-shadow: var(--shadow-card);">
              <div class="input-group mb-3">
                <input type="text" id="cekInput" class="form-control form-control-lg border-secondary-subtle" placeholder="Masukkan Kode Pendaftaran">
                <button class="btn btn-primary px-4" onclick="cekStatus()" style="border-radius: 0 10px 10px 0;">Cari</button>
              </div>
              <div id="hasilStatus" style="display: none; animation: fadeIn 0.5s;"></div>
            </div>
          </div>
        </div>
      </section>

    </div> 
    
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-4 mb-4">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
              <div style="width: 32px; height: 32px; background: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0f172a;">
                <i class="fas fa-graduation-cap"></i>
              </div>
              <h5 class="mb-0"><?= konfigurasi.footerJudul ?></h5>
            </div>
            <p class="small"><?= konfigurasi.footerAlamat ?></p>
          </div>
          
          <div class="col-md-2 mb-4">
            <h5>Navigasi</h5>
            <ul class="list-unstyled">
              <li class="mb-2"><a href="#" onclick="switchPage('beranda'); return false;">Beranda</a></li>
              <li class="mb-2"><a href="#" onclick="switchPage('alur'); return false;">Alur</a></li>
              <li class="mb-2"><a href="#" onclick="switchPage('daftar'); return false;">Daftar</a></li>
            </ul>
          </div>
   
          <div class="col-md-3 mb-4">
            <h5>Kontak</h5>
            <ul class="list-unstyled">
              <li class="mb-2"><i class="fas fa-phone me-2"></i> <?= konfigurasi.footerTelepon ?></li>
              <li class="mb-2"><i class="fas fa-envelope me-2"></i> <?= konfigurasi.footerEmail ?></li>
            </ul>
          </div>
          
          <div class="col-md-3">
            <h5>Sosial Media</h5>
            <div class="d-flex gap-3 mt-3">
              <? if(konfigurasi.linkFb && konfigurasi.linkFb.length > 2) { ?>
                  <a href="<?= konfigurasi.linkFb ?>" target="_blank" rel="noopener noreferrer" class="fs-5">
                    <i class="fab fa-facebook"></i>
                  </a>
              <? } ?>
              
              <? if(konfigurasi.linkIg && konfigurasi.linkIg.length > 2) { ?>
                  <a href="<?= konfigurasi.linkIg ?>" target="_blank" rel="noopener noreferrer" class="fs-5">
                    <i class="fab fa-instagram"></i>
                  </a>
              <? } ?>
              
              <? if(konfigurasi.linkYt && konfigurasi.linkYt.length > 2) { ?>
                  <a href="<?= konfigurasi.linkYt ?>" target="_blank" rel="noopener noreferrer" class="fs-5">
                    <i class="fab fa-youtube"></i>
                  </a>
              <? } ?>
            </div>
          </div>
        <div style="border-top: 1px solid #334155; margin-top: 40px; padding-top: 20px; text-align: center; font-size: 0.85rem;">
          <?= konfigurasi.footerHakCipta ?>
        </div>
      </div>
    </footer>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Login Admin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-4">
          <form id="loginForm" onsubmit="handleLoginSubmit(event)">
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="fas fa-user text-muted"></i></span>
                <input type="text" class="form-control bg-light border-0" id="adminUsername" placeholder="Username" required>
              </div>
            </div>
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="fas fa-key text-muted"></i></span>
                <input type="password" class="form-control bg-light border-0" id="adminPass" placeholder="Password" required>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 rounded-3">Masuk Dashboard</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="admin-section">
    <div id="wrapper">
      
      <div id="sidebar-wrapper">
        <div class="sidebar-brand">
          <div class="brand-icon"><i class="fas fa-shapes"></i></div>
          <div class="brand-text">SPMB Admin</div>
        </div>
        
        <div class="sidebar-profile-card">
          <div class="profile-img" id="sidebarAvatar">A</div>
          <div class="profile-info">
            <h6 id="sidebarName">Administrator</h6>
            <span id="sidebarRole">SUPER ADMIN</span>
          </div>
        </div>

        <div class="sidebar-menu">
          <div class="menu-label">Menu Utama</div>
          <a href="#" class="menu-item active" onclick="showAdminTab('dashboard'); setActiveMenu(this)">
            <i class="fas fa-home"></i> <span>Dashboard</span>
          </a>
          <a href="#" class="menu-item" onclick="showAdminTab('builder'); setActiveMenu(this)">
            <i class="fas fa-sliders-h"></i> <span>Konfigurasi Form</span>
          </a>
          <a href="#" class="menu-item" onclick="showAdminTab('configWeb'); setActiveMenu(this)">
            <i class="fas fa-desktop"></i> <span>Tampilan Website</span>
          </a>
          
          <div class="menu-label mt-4">Sistem</div>
          <a href="#" class="menu-item" style="color: #ef4444;" onclick="logoutAdmin()">
            <i class="fas fa-power-off"></i> <span>Log Out</span>
          </a>
        </div>
        
        <div class="sidebar-footer">SPMB System v2.0 â€¢ 2026</div>
      </div>

      <div id="page-content-wrapper">
        <div id="admin-navbar-container"></div>
        
        <div id="admin-main-content" class="container-fluid px-4 py-4"></div>
      </div>

    </div> 
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    // ==========================================
    // 0. INIT & GLOBAL CONFIG
    // ==========================================
    let formConfig = [];
    let fileUploadCache = {};
    let cachedPendaftar = []; // Menyimpan data pendaftar agar bisa dibuka di modal
    let ADMIN_TOKEN = localStorage.getItem('SPMB_admin_token') || null;

// --- VARIABEL UNTUK PAGINASI & FILTER ---
    let filteredPendaftar = []; // Data hasil search
    let currentPage = 1;
    let itemsPerPage = 10;

    // Konfigurasi Tailwind & Animasi
    if(typeof tailwind !== 'undefined') {
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#2563eb', secondary: '#64748b' },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.4s ease-out',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    }

    // Init AOS
    AOS.init({ once: true, offset: 50, duration: 800 });

    // Event Listener Utama
// ==========================================
    // MAIN EVENT LISTENER (INIT)
    // ==========================================
// ==========================================
// MAIN EVENT LISTENER (INIT & AUTO LOGIN)
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    
    // 1. Load Konfigurasi Form Pendaftaran (Builder)
    loadFormConfig();
    
    // 2. LOGIKA BARU: Cek Token Admin di LocalStorage (Auto Login)
    const savedToken = localStorage.getItem('SPMB_admin_token');
    
    if (savedToken) {
        // A. JIKA ADA TOKEN: Restore Session & Masuk Dashboard
        console.log("Token ditemukan. Mengembalikan sesi admin...");
        
        // Restore variabel global
        ADMIN_TOKEN = savedToken; 
        
        // Ganti Tampilan ke Admin
        document.getElementById('public-section').style.display = 'none';
        document.getElementById('admin-section').style.display = 'block';
        
        // Buka Tab Dashboard
        showAdminTab('dashboard');
        
        // (Opsional) Kita bisa memanggil fungsi cek validitas token ke server di sini,
        // tapi validasi sudah otomatis terjadi saat loadAdminData() dipanggil oleh showAdminTab.
        
    } else {
        // B. JIKA TIDAK ADA TOKEN: Tampilkan Halaman Publik
        document.getElementById('admin-section').style.display = 'none';
        document.getElementById('public-section').style.display = 'block';
    }
    
    // 3. Load Konfigurasi Tampilan Website (Hero, Footer, dll)
    google.script.run.withSuccessHandler(res => {
        if(res.success) {
            // Simpan data ke variabel global agar bisa diedit di form Admin Panel nanti
            currentWebConfig = res.data; 
            
            // Terapkan konfigurasi ke Halaman Depan (Public) secara langsung
            if(typeof applyPublicConfig === 'function') {
                applyPublicConfig(res.data);
            }
        } else {
            console.log('Gagal memuat konfigurasi website: ' + res.message);
        }
    }).getKonfigurasiAplikasi();
    
    // 4. Scroll Effect Navbar Public
    window.addEventListener('scroll', () => {
        const nav = document.querySelector('.public-navbar'); 
        if (nav) {
            if (window.scrollY > 50) {
                nav.style.boxShadow = "0 4px 20px rgba(0,0,0,0.05)";
                nav.classList.add('scrolled');
            } else {
                nav.style.boxShadow = "none";
                nav.classList.remove('scrolled');
            }
        }
    });

});
    // ==========================================
    // 1. TEMPLATES (TAILWIND CSS)
    // ==========================================
    
const AdminTemplates = {
        // A. Navbar Admin (TETAP SAMA)
        navbar: `
        <nav class="w-full bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 px-6 py-4 flex items-center justify-between transition-all duration-300">
          <div class="flex items-center gap-4">
            
            <button onclick="toggleSidebar()" class="p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all md:hidden">
              <i class="fas fa-bars text-lg"></i>
            </button>
            
            <button onclick="toggleSidebarDesktop()" class="hidden md:block p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all mr-2">
              <i class="fas fa-outdent text-lg transform transition-transform duration-300" id="btnToggleDesktop"></i>
            </button>

            <div class="flex flex-col">
              <h1 class="text-xl font-bold text-slate-800 tracking-tight" id="pageTitle">Dashboard Overview</h1>
              <p class="text-xs text-slate-500 font-medium" id="pageSubtitle">Pantau aktivitas pendaftaran terkini</p>
            </div>
          </div>
          
          <div class="flex items-center gap-4">
             <div class="hidden md:flex items-center gap-2 bg-emerald-50 border border-emerald-100 px-3 py-1.5 rounded-full">
               <span class="relative flex h-2.5 w-2.5">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
               </span>
               <span class="text-xs font-bold text-emerald-700">Live System</span>
             </div>
          </div>
        </nav>`,

        // B. Dashboard (UPDATED: ADA 2 MODAL DI SINI)
dashboard: `
        <div id="view-dashboard" class="animate-fade-in-up relative">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fas fa-users text-xl"></i></div>
                        <span class="flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md"><i class="fas fa-arrow-up"></i> Live</span>
                    </div>
                    <div class="text-slate-500 text-sm font-medium mb-1">Total Pendaftar</div>
                    <div class="text-3xl font-extrabold text-slate-800" id="statTotal">0</div>
                 </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-emerald-50 text-emerald-600 rounded-xl group-hover:bg-emerald-600 group-hover:text-white transition-colors"><i class="fas fa-check-circle text-xl"></i></div>
                        <span class="text-xs font-bold text-slate-400">Kuota Tersedia</span>
                    </div>
                    <div class="text-slate-500 text-sm font-medium mb-1">Siswa Diterima</div>
                    <div class="text-3xl font-extrabold text-emerald-600" id="statDiterima">0</div>
                 </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-amber-50 text-amber-600 rounded-xl group-hover:bg-amber-600 group-hover:text-white transition-colors"><i class="fas fa-clock text-xl"></i></div>
                        <span class="flex items-center gap-1 text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded-md"><i class="fas fa-exclamation-circle"></i> Perlu Review</span>
                    </div>
                    <div class="text-slate-500 text-sm font-medium mb-1">Menunggu Verifikasi</div>
                    <div class="text-3xl font-extrabold text-amber-500" id="statPending">0</div>
                 </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div>
                    <h2 class="text-lg font-bold text-slate-800">Data Pendaftar Terbaru</h2>
                    <p class="text-sm text-slate-500">Kelola data siswa yang masuk secara realtime.</p>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="downloadExcelReport()" class="px-4 py-2.5 bg-emerald-600 border border-emerald-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-emerald-600/20 hover:bg-emerald-700 hover:border-emerald-700 transition-all flex items-center gap-2">
                         <i class="fas fa-file-excel"></i> Export Excel
                    </button>

                    <button onclick="loadAdminData()" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-600 text-sm font-bold rounded-xl shadow-sm hover:bg-slate-50 hover:text-blue-600 hover:border-blue-200 transition-all flex items-center gap-2 group">
                        <i class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-500"></i> Refresh Data
                    </button>
                </div>
            </div>
              
            <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mb-10">
                 
                 <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-500 uppercase">Show</span>
                        <select id="entriesPerPage" onchange="changeEntries(this.value)" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="all">Semua</option>
                        </select>
                        <span class="text-xs font-bold text-slate-500 uppercase">Entries</span>
                    </div>

                    <div class="relative w-full md:w-64">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-slate-400"></i>
                        </div>
                        <input type="text" id="searchInput" onkeyup="handleSearch(this.value)" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2" placeholder="Cari Nama / NISN...">
                    </div>
                 </div>

                 <div class="overflow-x-auto">
                     <table class="w-full text-left border-collapse">
                      <thead>
                        <tr class="bg-slate-50/50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold">
                          <th class="px-6 py-4">Profil Siswa</th>
                          <th class="px-6 py-4">ID Pendaftaran</th>
                          <th class="px-6 py-4">Status</th>
                          <th class="px-6 py-4 text-center">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="dataGridContainer" class="divide-y divide-slate-100">
                        <tr><td colspan="4" class="px-6 py-12 text-center">Loading...</td></tr>
                      </tbody>
                    </table>
                 </div>

                 <div class="px-6 py-4 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/30">
                    <div class="text-sm text-slate-500">
                        Menampilkan <span id="showStart" class="font-bold text-slate-800">0</span> sampai <span id="showEnd" class="font-bold text-slate-800">0</span> dari <span id="showTotal" class="font-bold text-slate-800">0</span> data
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnPrev" onclick="changePage('prev')" class="px-3 py-1 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <span id="pageIndicator" class="px-3 py-1 text-sm font-bold text-blue-600 bg-blue-50 border border-blue-100 rounded-lg">
                            Page 1
                        </span>
                        <button id="btnNext" onclick="changePage('next')" class="px-3 py-1 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                 </div>
            </div>

            <div id="detailModalBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[1000] hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0" onclick="closeDetailModal()">
                  <div id="detailModalContent" class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 relative overflow-hidden flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
                      <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                          <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-id-card text-blue-500"></i> Detail Pendaftar</h3>
                          <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-rose-500 hover:bg-rose-50 hover:border-rose-200 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
                      </div>
                      <div class="p-6 overflow-y-auto" id="modalBodyHtml"></div>
                      <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                        <button onclick="closeDetailModal()" class="px-4 py-2 rounded-lg bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 font-bold text-sm">Tutup</button>
                      </div>
                  </div>
            </div>

            <div id="statusModalBackdrop" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[1050] hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
                  <div id="statusModalContent" class="bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 overflow-hidden" onclick="event.stopPropagation()">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                      <h3 class="font-bold text-slate-800 text-lg">Update Status</h3>
                      <button onclick="closeStatusModal()" class="text-slate-400 hover:text-rose-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="p-6">
                      <input type="hidden" id="editKodePendaftaran">
                      <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Pilih Status</label>
                        <div class="grid grid-cols-3 gap-2">
                          <button type="button" onclick="selectStatus('Diterima', this)" class="btn-status-opt p-2 border rounded-lg text-sm font-bold text-emerald-600 border-emerald-200 hover:bg-emerald-50 transition-all">Diterima</button>
                          <button type="button" onclick="selectStatus('Perbaikan', this)" class="btn-status-opt p-2 border rounded-lg text-sm font-bold text-amber-600 border-amber-200 hover:bg-amber-50 transition-all">Perbaikan</button>
                          <button type="button" onclick="selectStatus('Tidak Diterima', this)" class="btn-status-opt p-2 border rounded-lg text-sm font-bold text-rose-600 border-rose-200 hover:bg-rose-50 transition-all">Ditolak</button>
                        </div>
                        <input type="hidden" id="selectedStatus">
                      </div>
                      <div class="mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Catatan Admin</label>
                        <textarea id="editCatatan" class="w-full border border-slate-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" rows="4" placeholder="Tulis catatan untuk siswa..."></textarea>
                      </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                      <button onclick="saveStatusChange()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 hover:bg-blue-700 transition-all"><i class="fas fa-save me-2"></i> Simpan</button>
                    </div>
                  </div>
            </div>

        </div>`,
        

        // C. Builder (TETAP SAMA)
        builder: `
        <div id="view-builder" class="animate-fade-in-up">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div><h4 class="text-xl font-bold text-slate-800">Form Builder</h4><p class="text-sm text-slate-500">Kustomisasi kolom formulir pendaftaran.</p></div>
                <button onclick="saveBuilderConfig()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 transition-all flex items-center gap-2"><i class="fas fa-save"></i> Simpan Konfigurasi</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <div id="builderList" class="flex flex-col gap-4 min-h-[200px]"></div>
                        <div class="mt-6 pt-6 border-t border-dashed border-slate-200 text-center"><button onclick="addBuilderItem()" class="px-5 py-2 border-2 border-dashed border-blue-200 text-blue-600 font-bold rounded-xl hover:bg-blue-50 hover:border-blue-300 transition-all flex items-center gap-2 mx-auto"><i class="fas fa-plus-circle"></i> Tambah Pertanyaan Baru</button></div>
                    </div>
                </div>
                <div class="lg:col-span-1"><div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-xl shadow-blue-900/10"><div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm"><i class="fas fa-lightbulb"></i></div><h6 class="font-bold text-lg mb-4">Tips Konfigurasi</h6><ul class="space-y-3 text-sm text-blue-100/90 leading-relaxed list-disc pl-4"><li>Geser icon <b>grip</b> untuk mengubah urutan.</li><li>Gunakan tipe <b>Upload File</b> untuk dokumen.</li><li>Klik <b>Simpan</b> agar diterapkan.</li></ul></div></div>
            </div>
        </div>`,

      // ... (kode builder sebelumnya) ... `
        // JANGAN LUPA TANDA KOMA DI ATAS SINI SEBELUM MENAMBAHKAN configWeb

        configWeb: `
        <div id="view-config-web" class="animate-fade-in-up pb-10">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h4 class="text-xl font-bold text-slate-800">Tampilan Website</h4>
                    <p class="text-sm text-slate-500">Ubah konten halaman depan publik secara real-time.</p>
                </div>
                <button onclick="submitWebConfig()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 transition-all flex items-center gap-2">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
            </div>

            <form id="formConfigWeb">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h6 class="font-bold text-slate-800 border-b pb-2 mb-4 uppercase text-xs tracking-wider text-blue-600">
                            <i class="fas fa-id-card me-2"></i> Identitas & Hero
                        </h6>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nama Aplikasi (Navbar)</label>
                                <input type="text" name="appName" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="SPMB 2025">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul Sidebar Admin</label>
                                <input type="text" name="judulSidebar" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="SPMB Online">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Status Pendaftaran</label>
                            <select name="pendaftaranStatus" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500">
                                <option value="dibuka">ðŸŸ¢ DIBUKA (Tombol Daftar Aktif)</option>
                                <option value="ditutup">ðŸ”´ DITUTUP (Tombol Nonaktif)</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Logo URL</label>
                            <input type="text" name="logoUrl" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="https://...">
                        </div>
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Gambar Hero URL (Kanan)</label>
                            <input type="text" name="heroImageUrl" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="https://...">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Badge Hero (Teks Kecil Atas)</label>
                            <input type="text" name="teksHero" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Penerimaan Siswa Baru">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Headline Baris 1</label>
                                <input type="text" name="heroBaris1" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Masa Depan Cerah">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Headline Baris 2 (Warna)</label>
                                <input type="text" name="heroBaris2" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Dimulai Di Sini">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Subteks Hero</label>
                            <textarea name="heroSubteks" rows="2" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Deskripsi singkat di bawah judul..."></textarea>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h6 class="font-bold text-slate-800 border-b pb-2 mb-4 uppercase text-xs tracking-wider text-blue-600">
                            <i class="fas fa-address-book me-2"></i> Kontak & Footer
                        </h6>
                        
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul Footer</label>
                            <input type="text" name="footerJudul" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Nama Sekolah">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Email</label>
                                <input type="text" name="footerEmail" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Telepon/WA</label>
                                <input type="text" name="footerTelepon" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Alamat Lengkap</label>
                            <textarea name="footerAlamat" rows="2" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Teks Copyright</label>
                            <input type="text" name="footerHakCipta" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 focus:bg-white focus:border-blue-500 transition-colors" placeholder="Â© 2025...">
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-dashed border-slate-200">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Link Sosial Media (Kosongkan jika tidak ada)</p>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-facebook text-blue-600 w-6 text-center text-lg"></i>
                                    <input type="text" name="linkFb" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50" placeholder="https://facebook.com/...">
                                </div>
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-instagram text-rose-500 w-6 text-center text-lg"></i>
                                    <input type="text" name="linkIg" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50" placeholder="https://instagram.com/...">
                                </div>
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-youtube text-red-600 w-6 text-center text-lg"></i>
                                    <input type="text" name="linkYt" class="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 bg-slate-50" placeholder="https://youtube.com/...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                        <h6 class="font-bold text-slate-800 border-b pb-2 mb-4 uppercase text-xs tracking-wider text-blue-600">
                            <i class="fas fa-list-ol me-2"></i> Edit Alur Pendaftaran (4 Langkah)
                        </h6>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="p-4 border border-slate-200 rounded-xl bg-slate-50 relative group hover:border-blue-300 transition-all">
                                <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">STEP 1</div>
                                <div class="mt-2">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul</label>
                                    <input type="text" name="alur1_judul" class="w-full text-sm border border-slate-300 rounded mb-2 px-2 py-1 font-bold text-slate-700" placeholder="Isi Formulir">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deskripsi</label>
                                    <textarea name="alur1_desc" class="w-full text-xs border border-slate-300 rounded px-2 py-1 bg-white" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="p-4 border border-slate-200 rounded-xl bg-slate-50 relative group hover:border-blue-300 transition-all">
                                <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">STEP 2</div>
                                <div class="mt-2">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul</label>
                                    <input type="text" name="alur2_judul" class="w-full text-sm border border-slate-300 rounded mb-2 px-2 py-1 font-bold text-slate-700" placeholder="Upload Berkas">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deskripsi</label>
                                    <textarea name="alur2_desc" class="w-full text-xs border border-slate-300 rounded px-2 py-1 bg-white" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="p-4 border border-slate-200 rounded-xl bg-slate-50 relative group hover:border-blue-300 transition-all">
                                <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">STEP 3</div>
                                <div class="mt-2">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul</label>
                                    <input type="text" name="alur3_judul" class="w-full text-sm border border-slate-300 rounded mb-2 px-2 py-1 font-bold text-slate-700" placeholder="Verifikasi">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deskripsi</label>
                                    <textarea name="alur3_desc" class="w-full text-xs border border-slate-300 rounded px-2 py-1 bg-white" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="p-4 border border-slate-200 rounded-xl bg-slate-50 relative group hover:border-blue-300 transition-all">
                                <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">STEP 4</div>
                                <div class="mt-2">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Judul</label>
                                    <input type="text" name="alur4_judul" class="w-full text-sm border border-slate-300 rounded mb-2 px-2 py-1 font-bold text-slate-700" placeholder="Pengumuman">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Deskripsi</label>
                                    <textarea name="alur4_desc" class="w-full text-xs border border-slate-300 rounded px-2 py-1 bg-white" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>`


    };

    // ==========================================
    // 2. NAVIGASI SPA & MODAL LOGIC
    // ==========================================

    function toggleSidebar() { document.getElementById("wrapper").classList.toggle("toggled"); }
    function setActiveMenu(element) {
            // 1. Pindahkan kelas 'active' ke menu yang diklik
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            // 2. LOGIKA BARU: Jika di layar HP (lebar < 992px), tutup sidebar otomatis
            if (window.innerWidth < 992) {
                const wrapper = document.getElementById("wrapper");
                // Jika sidebar sedang terbuka (ada class toggled), tutup sidebar
                if (wrapper.classList.contains("toggled")) {
                    toggleSidebar();
                }
            }
        }

let currentWebConfig = {};

    // UPDATE FUNGSI showAdminTab
    function showAdminTab(viewName) {
        const navContainer = document.getElementById('admin-navbar-container');
        if(navContainer.innerHTML === '') navContainer.innerHTML = AdminTemplates.navbar;
        
        const mainContainer = document.getElementById('admin-main-content');
        
        if (viewName === 'dashboard') {
            mainContainer.innerHTML = AdminTemplates.dashboard;
            loadAdminData();
        } 
        else if (viewName === 'builder') {
            mainContainer.innerHTML = AdminTemplates.builder;
            renderBuilder(formConfig);
        }
        else if (viewName === 'configWeb') {
            // Tampilkan Template Baru
            mainContainer.innerHTML = AdminTemplates.configWeb || '<div class="p-6 text-center">Template configWeb belum dipasang di AdminTemplates</div>';
            document.getElementById('pageTitle').innerText = 'Tampilan Website';
            document.getElementById('pageSubtitle').innerText = 'Edit konten halaman depan';
            
            // Isi Form dengan data saat ini (jika ada)
            const form = document.getElementById('formConfigWeb');
            if(currentWebConfig && form) {
                Object.keys(currentWebConfig).forEach(key => {
                    if(form.elements[key]) form.elements[key].value = currentWebConfig[key];
                });
            }
        }
    }

    // FUNGSI SIMPAN
// FUNGSI SIMPAN (DIPERBAIKI: TANPA RELOAD)
    function submitWebConfig() {
        const form = document.getElementById('formConfigWeb');
        const formData = {};
        
        // Ambil semua input
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(el => { if(el.name) formData[el.name] = el.value; });

        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                // 1. Update variabel global currentWebConfig dengan data baru
                // Ini penting agar jika kita pindah tab admin, datanya tetap update
                currentWebConfig = formData;

                // 2. Terapkan langsung ke tampilan Public (Preview di belakang layar)
                // Jadi admin tidak perlu refresh untuk melihat efeknya jika logout
                if(typeof applyPublicConfig === 'function') {
                    applyPublicConfig(formData);
                }

                // 3. Tampilkan pesan sukses TANPA reload halaman
                Swal.fire('Berhasil', 'Tampilan website diperbarui!', 'success');
                
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }).saveWebConfig(ADMIN_TOKEN, formData);
    }

    // --- LOGIKA MODAL DETAIL ---


    function closeDetailModal() {
        const backdrop = document.getElementById('detailModalBackdrop');
        const content = document.getElementById('detailModalContent');
        
        // Animasi Keluar
        backdrop.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');

        setTimeout(() => {
            backdrop.classList.add('hidden');
        }, 300); // Sesuaikan dengan durasi transition CSS
    }


    // ==========================================
    // 3. AUTHENTICATION
    // ==========================================

    function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }

    function handleLoginSubmit(e) {
        e.preventDefault();
        
        // 1. Ambil Input User
        const username = document.getElementById('adminUsername').value;
        const pass = document.getElementById('adminPass').value;
        
        // 2. UI Loading State (Ubah tombol jadi loading)
        const btn = e.target.querySelector('button');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; 
        btn.disabled = true;

        // 3. Kirim ke Server (Backend)
        google.script.run.withSuccessHandler(res => {
            // Balikin tombol ke semula
            btn.innerHTML = oldText; 
            btn.disabled = false;
            
            if(res.success) {
                // === BAGIAN PENTING: SECURITY ===
                // 4. Simpan Token Session ID
                // Simpan ke variabel global (untuk penggunaan langsung)
                ADMIN_TOKEN = res.sessionId;
                
                // Simpan ke LocalStorage (agar user tidak perlu login ulang saat refresh page)
                localStorage.setItem('SPMB_admin_token', res.sessionId);

                // 5. Tutup Modal Login
                const modalEl = document.getElementById('loginModal');
                let modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (!modalInstance) modalInstance = new bootstrap.Modal(modalEl);
                modalInstance.hide();

                // 6. Ganti Tampilan ke Mode Admin
                document.getElementById('public-section').style.display = 'none';
                document.getElementById('admin-section').style.display = 'block'; 
                
                // 7. Load Dashboard Admin
                showAdminTab('dashboard');

                // 8. Update Info Profil di Sidebar
                document.getElementById('sidebarName').innerText = res.data.nama || 'Administrator';
                document.getElementById('sidebarRole').innerText = res.data.role || 'Super Admin';
                document.getElementById('sidebarAvatar').innerText = (res.data.nama || 'A').charAt(0).toUpperCase();

                // 9. Tampilkan Notifikasi Sukses
                Swal.fire({ 
                    icon: 'success', 
                    title: 'Login Berhasil', 
                    toast: true, 
                    position: 'top-end', 
                    showConfirmButton: false, 
                    timer: 2000 
                });

            } else { 
                // Jika Password/Username Salah
                Swal.fire('Gagal', res.message, 'error'); 
            }

        }).handleLogin({ loginType: 'admin', username: username, password: pass });
    }

function logoutAdmin() {
    Swal.fire({
        title: 'Keluar?',
        text: 'Sesi Anda akan diakhiri.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Logout',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {

            // 1. SECURITY WIPE (SERVER SIDE)
            // Panggil fungsi server untuk menghapus token dari CacheService
            // Kita jalankan secara "Fire and Forget" (tidak perlu tunggu respon)
            if (typeof ADMIN_TOKEN !== 'undefined' && ADMIN_TOKEN) {
                try {
                    // Pastikan Anda sudah menambahkan fungsi logoutServer di code.gs
                    google.script.run.logoutServer(ADMIN_TOKEN);
                } catch (e) {
                    console.warn("Gagal logout server:", e);
                }
            }

            // 2. SECURITY WIPE (CLIENT SIDE)
            // Hapus token dari variabel global memori
            ADMIN_TOKEN = null;
            
            // Hapus token dari penyimpanan browser (mencegah Auto Login)
            localStorage.removeItem('SPMB_admin_token');

            // 3. UI RESET: KEMBALI KE TAMPILAN PUBLIK
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('public-section').style.display = 'block';

            // 4. BERSIHKAN FORM LOGIN
            const loginForm = document.getElementById('loginForm');
            if(loginForm) loginForm.reset();

            // 5. BERSIHKAN DATA TABEL (Agar kosong jika login ulang)
            const gridContainer = document.getElementById('dataGridContainer');
            if(gridContainer) gridContainer.innerHTML = '';

            // 6. FEEDBACK
            Swal.fire({
                icon: 'success',
                title: 'Logout Berhasil',
                text: 'Sampai jumpa kembali.',
                timer: 1500,
                showConfirmButton: false
            });
        }
    });
}

// Tambahkan fungsi ini di code.gs
function logoutServer(token) {
  try {
    // Hapus token dari Cache Server
    CacheService.getUserCache().remove(token);
    return { success: true };
  } catch (e) {
    return { success: false };
  }
}

    // ==========================================
    // 4. DATA MANAGEMENT (TAILWIND TABLE)
    // ==========================================

    // Load Data Admin (Dashboard) - SECURE
function loadAdminData() {
    // 1. SECURITY CHECK (Client Side)
    // Pastikan token ada sebelum request ke server
    if (typeof ADMIN_TOKEN === 'undefined' || !ADMIN_TOKEN) {
        console.warn("Token tidak ditemukan, mengarahkan ke logout.");
        logoutAdmin();
        return;
    }

    const container = document.getElementById('dataGridContainer');
    if (!container) return;

    // 2. TAMPILKAN LOADING SPINNER
    container.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center"><div class="flex flex-col items-center"><div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div><span class="text-slate-500 text-sm">Memuat data...</span></div></td></tr>';

    // 3. REQUEST KE SERVER (DENGAN TOKEN)
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            // === SUKSES ===
            
            // A. Simpan Data Utama ke Cache
            cachedPendaftar = res.data || []; 
            
            // B. [INTEGRASI FITUR BARU] 
            // Salin data ke variabel filter untuk keperluan Search & Pagination
            filteredPendaftar = [...cachedPendaftar]; 

            // C. Update Angka Statistik di Dashboard
            const elTotal = document.getElementById('statTotal');
            const elTerima = document.getElementById('statDiterima');
            const elPending = document.getElementById('statPending');

            if (elTotal) elTotal.innerText = cachedPendaftar.length;
            if (elTerima) elTerima.innerText = cachedPendaftar.filter(d => d.status === 'Diterima').length;
            if (elPending) elPending.innerText = cachedPendaftar.filter(d => d.status === 'Pending').length;

            // D. [INTEGRASI FITUR BARU] 
            // Reset ke Halaman 1 dan panggil fungsi paginasi
            // Fungsi ini akan otomatis memanggil renderTable() sesuai jumlah baris yang dipilih
            currentPage = 1;
            updatePagination(); 

        } else {
            // === GAGAL / ERROR ===
            
            // Cek apakah error disebabkan oleh Token Invalid/Expired
            if (res.message && (res.message.includes("Akses Ditolak") || res.message.includes("Sesi Kadaluarsa") || res.message.includes("Forbidden"))) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sesi Berakhir',
                    text: 'Token akses Anda kadaluarsa atau tidak valid. Silakan login kembali.',
                    confirmButtonText: 'Login Ulang',
                    allowOutsideClick: false
                }).then(() => {
                    logoutAdmin(); // Paksa Logout
                });
            } else {
                // Error Biasa (Misal koneksi database atau error script)
                container.innerHTML = `<tr><td colspan="4" class="text-center text-rose-500 py-8 font-bold"><i class="fas fa-exclamation-circle me-2"></i> ${res.message}</td></tr>`;
            }
        }
    }).getAllPendaftar(ADMIN_TOKEN); // <--- KRUSIAL: KIRIM TOKEN KE SERVER
}

function renderTable(data) {
        const container = document.getElementById('dataGridContainer');
        if(!data || data.length === 0) {
            container.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center"><div class="flex flex-col items-center justify-center text-slate-400"><i class="fas fa-inbox text-3xl mb-3"></i><p class="font-medium">Belum ada data.</p></div></td></tr>`;
            return;
        }

        let html = '';
        data.forEach((row, index) => {
            // Logic Warna Status
            let badgeClass = 'bg-slate-100 text-slate-600';
            if(row.status === 'Diterima') badgeClass = 'bg-emerald-100 text-emerald-700 border-emerald-200';
            if(row.status === 'Tidak Diterima') badgeClass = 'bg-rose-100 text-rose-700 border-rose-200';
            if(row.status === 'Pending') badgeClass = 'bg-amber-50 text-amber-700 border-amber-200';
            if(row.status === 'Perbaikan') badgeClass = 'bg-orange-50 text-orange-700 border-orange-200'; // Warna Status Perbaikan

            let initials = row.nama ? row.nama.match(/(\b\S)?/g).join("").match(/(^\S|\S$)?/g).join("").toUpperCase() : "?";
            const gradients = ['from-blue-100 to-indigo-100 text-blue-600', 'from-purple-100 to-fuchsia-100 text-purple-600', 'from-emerald-100 to-teal-100 text-emerald-600', 'from-orange-100 to-amber-100 text-orange-600'];
            let avatarClass = gradients[index % gradients.length];

            html += `
            <tr class="hover:bg-slate-50/80 transition-colors duration-200 border-b border-slate-50 last:border-0 group">
              <td class="px-6 py-4">
                 <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br ${avatarClass} flex items-center justify-center font-bold text-sm shadow-sm ring-2 ring-white">${initials}</div>
                  <div>
                     <h6 class="font-bold text-slate-700 text-sm">${row.nama}</h6>
                     <div class="flex items-center gap-2 mt-0.5"><span class="text-xs text-slate-400 font-medium tracking-wide">NISN: ${row.nisn || '-'}</span></div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="font-mono text-xs font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded inline-block">${row.kodePendaftaran}</div>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold ${badgeClass}">${row.status}</span>
              </td>
              <td class="px-6 py-4 text-center">
                 <div class="flex items-center justify-center gap-2">
                    <button onclick="openStatusModal('${row.kodePendaftaran}', event)" class="w-8 h-8 rounded-lg bg-orange-50 border border-orange-200 text-orange-600 hover:bg-orange-500 hover:text-white transition-all shadow-sm flex items-center justify-center" title="Update Status">
                        <i class="fas fa-pencil-alt text-xs"></i>
                    </button>
                    <button onclick="openDetailModal('${row.kodePendaftaran}')" class="w-8 h-8 rounded-lg bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white transition-all shadow-sm flex items-center justify-center" title="Lihat Detail">
                        <i class="fas fa-eye text-xs"></i>
                    </button>
                 </div>
              </td>
            </tr>`;
        });
        container.innerHTML = html;
    }

    function updateStatus(kode, status) {
        closeDetailModal(); // Tutup modal dulu
        Swal.showLoading();
        google.script.run.withSuccessHandler(res => {
            if(res.success) { Swal.fire('Berhasil', 'Status: '+status, 'success'); loadAdminData(); }
            else { Swal.fire('Gagal', res.message, 'error'); }
        }).updateStatus(kode, status);
    }

    // Hapus Data Pendaftar (Frontend) - SECURE
    function deletePendaftar(kode) {
        // 1. SECURITY CHECK (Client Side)
        // Pastikan admin sedang login (punya token)
        if (!ADMIN_TOKEN) {
            console.warn("Akses ditolak: Token tidak ditemukan.");
            logoutAdmin();
            return;
        }

        // 2. UI SETUP
        closeDetailModal(); // Tutup modal detail jika sedang terbuka

        // 3. KONFIRMASI USER
        Swal.fire({
            title: 'Hapus Data?',
            text: "Data yang dihapus tidak dapat dikembalikan lagi!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus',
            cancelButtonText: 'Batal'
        })
        .then((result) => {
            if (result.isConfirmed) {
                
                // Tampilkan Loading
                Swal.fire({
                    title: 'Sedang Menghapus...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // 4. REQUEST KE SERVER (Pass Token + Kode)
                google.script.run.withSuccessHandler(res => {
                    if (res.success) {
                        // === SUKSES ===
                        Swal.fire(
                            'Terhapus!',
                            'Data pendaftar berhasil dihapus.',
                            'success'
                        );
                        loadAdminData(); // Refresh Tabel Data
                    } else {
                        // === GAGAL ===
                        // Cek jika kegagalan disebabkan oleh masalah keamanan (Token Expired/Invalid)
                        if (res.message.includes("Akses Ditolak") || res.message.includes("Sesi Kadaluarsa")) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Gagal Menghapus',
                                text: 'Sesi login Anda telah berakhir. Silakan login kembali.',
                                confirmButtonText: 'Login Ulang'
                            }).then(() => {
                                logoutAdmin(); // Logout otomatis
                            });
                        } else {
                            // Error Biasa (Misal data sudah tidak ada di sheet)
                            Swal.fire('Gagal', res.message, 'error');
                        }
                    }
                }).deletePendaftar(ADMIN_TOKEN, kode); // <--- KRUSIAL: KIRIM TOKEN DISINI
            }
        });
    }

// ==========================================
    // LOGIC BARU: STATUS & CATATAN
    // ==========================================

    // 1. Buka Modal Status
    function openStatusModal(kode, e) {
        if(e) e.stopPropagation();
        const data = cachedPendaftar.find(d => String(d.kodePendaftaran) === String(kode));
        if(!data) return;

        // Reset & Isi Form
        document.getElementById('editKodePendaftaran').value = kode;
        document.getElementById('editCatatan').value = data.catatanAdmin || '';
        document.querySelectorAll('.btn-status-opt').forEach(btn => btn.classList.remove('bg-emerald-600', 'text-white', 'bg-amber-600', 'bg-rose-600'));
        
        // Tandai tombol status saat ini
        const current = data.status;
        document.getElementById('selectedStatus').value = current;
        const btns = document.querySelectorAll('.btn-status-opt');
        if(current === 'Diterima') btns[0].classList.add('bg-emerald-600', 'text-white');
        if(current === 'Perbaikan') btns[1].classList.add('bg-amber-600', 'text-white');
        if(current === 'Tidak Diterima') btns[2].classList.add('bg-rose-600', 'text-white');

        // Show Modal
        const backdrop = document.getElementById('statusModalBackdrop');
        backdrop.classList.remove('hidden');
        setTimeout(() => {
             backdrop.classList.remove('opacity-0');
             backdrop.querySelector('#statusModalContent').classList.remove('scale-95');
             backdrop.querySelector('#statusModalContent').classList.add('scale-100');
        }, 10);
    }

    function selectStatus(val, el) {
        document.getElementById('selectedStatus').value = val;
        document.querySelectorAll('.btn-status-opt').forEach(btn => btn.classList.remove('bg-emerald-600', 'text-white', 'bg-amber-600', 'bg-rose-600'));
        if(val === 'Diterima') el.classList.add('bg-emerald-600', 'text-white');
        if(val === 'Perbaikan') el.classList.add('bg-amber-600', 'text-white');
        if(val === 'Tidak Diterima') el.classList.add('bg-rose-600', 'text-white');
    }

    function saveStatusChange() {
        const kode = document.getElementById('editKodePendaftaran').value;
        const status = document.getElementById('selectedStatus').value;
        const catatan = document.getElementById('editCatatan').value;

        closeStatusModal();
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                Swal.fire('Berhasil', 'Data diperbarui', 'success');
                loadAdminData();
            } else { 
                Swal.fire('Gagal', res.message, 'error'); 
            }
        }).updateStatus(ADMIN_TOKEN, kode, status, catatan); // <--- KIRIM TOKEN DISINI
    }

    function closeStatusModal() {
        const backdrop = document.getElementById('statusModalBackdrop');
        backdrop.classList.add('opacity-0');
        backdrop.querySelector('#statusModalContent').classList.add('scale-95');
        setTimeout(() => backdrop.classList.add('hidden'), 300);
    }

// ==========================================
    // PERBAIKAN: LOGIC MODAL DETAIL (READ ONLY)
    // ==========================================

// ==========================================
// PERBAIKAN: LOGIC MODAL DETAIL (FIXED)
// ==========================================

function openDetailModal(kode) {
    // 1. Cari Data Pendaftar dari Cache
    const data = cachedPendaftar.find(d => String(d.kodePendaftaran) === String(kode));
    
    // Safety Check: Jika data tidak ditemukan
    if(!data) {
        console.error('Data not found for:', kode);
        return Swal.fire('Error', 'Data pendaftar tidak ditemukan.', 'error');
    }

    // 2. Ambil Elemen Modal
    const backdrop = document.getElementById('detailModalBackdrop');
    const modalBody = document.getElementById('modalBodyHtml');
    const content = document.getElementById('detailModalContent');

    if(!backdrop || !modalBody) return;

    // 3. Setup Tampilan Status (Warna & Icon)
    let statusColor = 'bg-amber-100 text-amber-700 border-amber-200';
    let statusIcon = '<i class="fas fa-clock"></i>';
    
    if(data.status === 'Diterima') { 
        statusColor = 'bg-emerald-100 text-emerald-700 border-emerald-200';
        statusIcon = '<i class="fas fa-check-circle"></i>'; 
    } else if(data.status === 'Tidak Diterima') { 
        statusColor = 'bg-rose-100 text-rose-700 border-rose-200';
        statusIcon = '<i class="fas fa-times-circle"></i>'; 
    } else if(data.status === 'Perbaikan') { 
        statusColor = 'bg-orange-100 text-orange-700 border-orange-200';
        statusIcon = '<i class="fas fa-exclamation-triangle"></i>'; 
    }

    // Generate Initials (Ambil 2 huruf pertama nama)
    let namaSiswa = data.nama || 'Siswa';
    let initials = namaSiswa.substring(0, 2).toUpperCase();

    // 4. GENERATE LIST DOKUMEN SECARA OTOMATIS (DINAMIS)
    // Mengambil daftar kolom yang terdeteksi sebagai file dari backend (_fileKeys)
    const fileKeys = data._fileKeys || [];
    
    let dokumenHtml = '';
    if (fileKeys.length > 0) {
        dokumenHtml = fileKeys.map(key => {
            // Bersihkan label (misal "Upload KTP" jadi "KTP")
            let label = key.replace(/upload/gi, '').trim();
            if(!label) label = key;

            // Tentukan Icon berdasarkan nama file secara cerdas
            let icon = 'fa-file-alt'; // Default icon
            let lowerKey = key.toLowerCase();
            if(lowerKey.includes('foto')) icon = 'fa-image';
            if(lowerKey.includes('ijazah') || lowerKey.includes('skl')) icon = 'fa-certificate';
            if(lowerKey.includes('ktp') || lowerKey.includes('kk') || lowerKey.includes('kartu')) icon = 'fa-id-card';

            // Render Tombol untuk setiap file
            return `
            <a href="${data[key]}" target="_blank" class="flex items-center gap-3 p-2.5 bg-white border border-slate-200 rounded-lg hover:border-blue-400 hover:shadow-sm transition-all text-sm text-slate-600 group mb-2 text-decoration-none">
                <div class="w-8 h-8 rounded bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="flex-1 overflow-hidden text-start">
                     <span class="font-bold text-slate-700 truncate block text-xs uppercase">${label}</span>
                     <span class="text-[10px] text-slate-400">Klik untuk melihat</span>
                </div>
                <i class="fas fa-external-link-alt text-xs text-slate-300"></i>
            </a>`;
        }).join('');
    } else {
        // Jika tidak ada file sama sekali
        dokumenHtml = `<div class="p-3 text-xs text-slate-400 italic text-center border border-dashed border-slate-200 rounded bg-slate-50">Tidak ada dokumen terlampir</div>`;
    }

    // 5. Generate List Data Diri (Kanan)
    // Daftar key yang TIDAK BOLEH muncul di list data diri (karena sudah ada di tempat lain)
    const ignoreKeys = [
        'kodePendaftaran', 'nama', 'nisn', 'status', 'catatanAdmin', 
        'Tanggal Daftar', 'tanggalDaftar'
    ];
    
    // Gabungkan ignoreKeys manual dengan fileKeys agar file tidak muncul double
    const allIgnore = [...ignoreKeys, ...fileKeys];

    const dataListHtml = Object.keys(data).map(key => {
        // Filter Metadata & System Keys
        if(key.startsWith('_')) return ''; 
        if(allIgnore.includes(key)) return ''; 
        if(key.startsWith('url') && key !== 'url') return ''; // Skip legacy url keys jika ada

        return `
        <div class="border-b border-slate-100 pb-2 mb-2 last:border-0">
            <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider">
                ${key}
            </p>
            <p class="text-sm font-semibold text-slate-700 break-words">
                ${data[key] || '-'}
            </p>
        </div>`;
    }).join('');

    // 6. Render Modal Body HTML
    modalBody.innerHTML = `
    <div class="flex flex-col md:flex-row gap-6">
        <div class="md:w-1/3 flex flex-col">
            <div class="flex flex-col items-center text-center mb-6">
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-3xl font-bold shadow-lg ring-4 ring-white mb-4">
                    ${initials}
                </div>
                <h4 class="font-bold text-slate-800 text-lg leading-tight px-2">${data.nama}</h4>
                <p class="text-slate-500 text-sm mb-3 mt-1">NISN: ${data.nisn || '-'}</p>
                
                <span class="px-4 py-1.5 rounded-full text-xs font-bold border ${statusColor} flex items-center gap-2">
                    ${statusIcon} ${data.status}
                </span>
            </div>

            <div class="w-full bg-slate-50 rounded-xl p-4 border border-slate-100 text-left flex-grow">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3 border-b border-slate-200 pb-2">
                    <i class="fas fa-paperclip me-1"></i> Dokumen Pendukung
                </p>
                <div class="space-y-1">
                    ${dokumenHtml}
                </div>
            </div>
        </div>

        <div class="md:w-2/3 space-y-4">
             <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">ID Pendaftaran</p>
                    <p class="font-mono font-bold text-slate-700 text-lg">${data.kodePendaftaran}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Tanggal Daftar</p>
                    <p class="text-xs font-semibold text-slate-600">${data['Tanggal Daftar'] || '-'}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-x-4 gap-y-2 max-h-[400px] overflow-y-auto pr-2">
                ${dataListHtml}
            </div>
            
            <div class="mt-4 pt-4 border-t border-dashed border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Catatan Admin</p>
                <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 text-sm text-slate-600 italic">
                    "${data.catatanAdmin || 'Belum ada catatan.'}"
                </div>
            </div>
        </div>
    </div>`;

    // 7. Tampilkan Modal dengan Animasi
    backdrop.classList.remove('hidden');
    backdrop.style.zIndex = '9999'; 
    
    setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
    }, 10);
}

    function closeDetailModal() {
        const backdrop = document.getElementById('detailModalBackdrop');
        const content = document.getElementById('detailModalContent');
        
        // Animasi Keluar
        backdrop.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        
        // Tunggu animasi selesai baru hidden
        setTimeout(() => {
            backdrop.classList.add('hidden');
        }, 300);
    }
    // ==========================================
    // 5. BUILDER LOGIC
    // ==========================================
    function saveBuilderConfig() {
        let newConfig = [];
        document.querySelectorAll('.builder-item').forEach(el => {
            const label = el.querySelector('.b-label').value.trim();
            if(label) newConfig.push({ label: label, type: el.querySelector('.b-type').value, options: el.querySelector('.b-opts').value, width: el.querySelector('.b-width').value, required: el.querySelector('.b-req').checked });
        });
        if(newConfig.length === 0) return Swal.fire('Error', 'Minimal 1 pertanyaan.', 'warning');
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        google.script.run.withSuccessHandler(res => { Swal.fire('Sukses', 'Disimpan!', 'success'); formConfig = newConfig; renderBuilder(newConfig); renderUserForm(newConfig); }).saveFormConfig(ADMIN_TOKEN, newConfig);
    }

    function renderBuilder(config) {
        const list = document.getElementById('builderList'); if(!list) return;
        let html = ''; if(config) config.forEach(c => html += createBuilderRow(c)); list.innerHTML = html;
    }

function createBuilderRow(data = {label:'', type:'text', width:'12', required:false, options:''}) {
        const isSel = (v) => data.type === v ? 'selected' : '';
        const isW = (v) => String(data.width) === String(v) ? 'selected' : '';
        const showOpt = data.type === 'dropdown' ? 'block' : 'none';

        // 1. Generate Opsi yang sudah ada
        let existingOptsHtml = '';
        if(data.options) {
            const optsArr = data.options.split(',');
            optsArr.forEach(opt => {
                existingOptsHtml += `
                <div class="dropdown-option-row">
                    <input type="text" value="${opt.trim()}" oninput="syncOptValue(this)" placeholder="Nama Pilihan...">
                    <button class="btn-remove-opt" onclick="removeOptRow(this)"><i class="fas fa-times"></i></button>
                </div>`;
            });
        }
        if(existingOptsHtml === '') {
            existingOptsHtml = `
            <div class="dropdown-option-row">
                <input type="text" oninput="syncOptValue(this)" placeholder="Nama Pilihan (Contoh: Laki-laki)">
                <button class="btn-remove-opt" onclick="removeOptRow(this)"><i class="fas fa-times"></i></button>
            </div>`;
        }

        return `
        <div class="builder-item p-4 mb-4 bg-slate-50 border border-slate-200 rounded-xl hover:shadow-md transition-all group">
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                <div class="flex-shrink-0 pt-2 md:pt-0">
                    <i class="fas fa-grip-vertical handle text-slate-300 hover:text-blue-500 cursor-grab text-lg"></i>
                </div>
                
                <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-3 w-full">
                    <div class="md:col-span-4">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Label Pertanyaan</label>
                        <input type="text" class="w-full text-sm bg-white border border-slate-300 rounded-lg px-3 py-2 b-label" value="${data.label}" placeholder="Contoh: Agama">
                    </div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipe Input</label>
                        <select class="w-full text-sm bg-white border border-slate-300 rounded-lg px-3 py-2 b-type" onchange="toggleOpt(this)">
                            <option value="text" ${isSel('text')}>Teks Singkat</option>
                            <option value="textarea" ${isSel('textarea')}>Paragraf</option>
                            <option value="number" ${isSel('number')}>Angka</option>
                            <option value="date" ${isSel('date')}>Tanggal</option>
                            <option value="dropdown" ${isSel('dropdown')}>Pilihan Ganda (Dropdown)</option>
                            <option value="file" ${isSel('file')}>Upload File</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Lebar Form</label>
                        <select class="w-full text-sm bg-white border border-slate-300 rounded-lg px-3 py-2 b-width">
                            <option value="12" ${isW('12')}>Full (1 Baris)</option>
                            <option value="6" ${isW('6')}>1/2 (2 Kolom)</option>
                            <option value="4" ${isW('4')}>1/3 (3 Kolom)</option>
                            <option value="3" ${isW('3')}>1/4 (4 Kolom)</option>
                            <option value="one-fifth" ${isW('one-fifth')}>1/5 (5 Kolom)</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2 flex flex-col items-center">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Wajib Diisi?</label>
                        <input class="w-5 h-5 b-req rounded text-blue-600 focus:ring-blue-500" type="checkbox" ${data.required ? 'checked' : ''}>
                    </div>
                </div>

                <div class="flex-shrink-0 self-end md:self-center">
                    <button class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-rose-400 hover:text-rose-600 hover:bg-rose-50 transition-colors flex items-center justify-center" onclick="this.closest('.builder-item').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="opt-area mt-4 pl-0 md:pl-8 border-t border-dashed border-slate-200 pt-3" style="display:${showOpt};">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Daftar Pilihan</label>
                <input type="hidden" class="b-opts" value="${data.options || ''}">
                <div class="dropdown-list-container">
                    ${existingOptsHtml}
                </div>
                <button class="btn-add-opt mt-2" onclick="addOptRow(this)">
                    <i class="fas fa-plus"></i> Tambah Pilihan Lain
                </button>
            </div>
        </div>`;
    }

    // Toggle Tampilan area opsi saat tipe diganti
    function toggleOpt(el) {
        const item = el.closest('.builder-item');
        const area = item.querySelector('.opt-area');
        area.style.display = el.value === 'dropdown' ? 'block' : 'none';
        
        // Jika di-set ke dropdown tapi kosong, tambah 1 baris otomatis
        if(el.value === 'dropdown') {
            const container = item.querySelector('.dropdown-list-container');
            if(container.children.length === 0) addOptRow(item.querySelector('.btn-add-opt'));
        }
    }

    // Fungsi: Menambah Baris Pilihan Baru
    function addOptRow(btn) {
        const container = btn.previousElementSibling; // div.dropdown-list-container
        const html = `
        <div class="dropdown-option-row">
            <input type="text" oninput="syncOptValue(this)" placeholder="Pilihan baru...">
            <button class="btn-remove-opt" onclick="removeOptRow(this)"><i class="fas fa-times"></i></button>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        
        // Fokus ke input yang baru dibuat
        const inputs = container.querySelectorAll('input');
        inputs[inputs.length - 1].focus();
    }

    // Fungsi: Menghapus Baris Pilihan
    function removeOptRow(btn) {
        const row = btn.closest('.dropdown-option-row');
        const container = row.parentElement;
        
        // Animasi hapus sedikit
        row.style.opacity = '0';
        setTimeout(() => {
            row.remove();
            // Update hidden value setelah hapus, 
            // kita panggil sync dari salah satu input yang tersisa (jika ada)
            const remainingInput = container.querySelector('input');
            if(remainingInput) syncOptValue(remainingInput);
            else {
                // Jika habis, kosongkan hidden value
                container.closest('.opt-area').querySelector('.b-opts').value = "";
            }
        }, 200);
    }

    // Fungsi: Sinkronisasi (Gabungkan semua input kecil menjadi satu string koma)
    function syncOptValue(inputEl) {
        const area = inputEl.closest('.opt-area');
        const container = area.querySelector('.dropdown-list-container');
        const hiddenInput = area.querySelector('.b-opts');
        
        // Ambil semua nilai input kecil
        let values = [];
        container.querySelectorAll('input').forEach(inp => {
            if(inp.value.trim() !== "") {
                values.push(inp.value.trim());
            }
        });
        
        // Gabungkan dengan koma dan simpan ke hidden input
        hiddenInput.value = values.join(', ');
    }
    

    function addBuilderItem() { document.getElementById('builderList').insertAdjacentHTML('beforeend', createBuilderRow()); }

    // ==========================================
    // 6. PUBLIC FUNCTIONS
    // ==========================================
    function loadFormConfig() { google.script.run.withSuccessHandler(config => { formConfig = config; renderUserForm(config); }).getFormConfig(); }

    function detectIcon(label) {
        label = label.toLowerCase();
        
        // Mapping Kata Kunci ke FontAwesome Class
        if (label.includes('nama')) return 'fas fa-user';
        if (label.includes('ibu') || label.includes('ayah') || label.includes('wali')) return 'fas fa-user-friends';
        if (label.includes('telepon') || label.includes('hp') || label.includes('wa') || label.includes('nomor')) return 'fas fa-phone-alt';
        if (label.includes('email')) return 'fas fa-envelope';
        if (label.includes('lahir') || label.includes('tanggal') || label.includes('tahun')) return 'fas fa-calendar-alt';
        if (label.includes('alamat') || label.includes('domisili') || label.includes('tempat')) return 'fas fa-map-marker-alt';
        if (label.includes('sekolah') || label.includes('pendidikan') || label.includes('kelas') || label.includes('ijazah')) return 'fas fa-school';
        if (label.includes('nisn') || label.includes('nik') || label.includes('nis')) return 'fas fa-id-card';
        if (label.includes('kelamin')) return 'fas fa-venus-mars';
        if (label.includes('agama')) return 'fas fa-pray';
        if (label.includes('darah')) return 'fas fa-heartbeat';
        if (label.includes('berat')) return 'fas fa-weight';
        if (label.includes('tinggi')) return 'fas fa-ruler-vertical';
        if (label.includes('hobi') || label.includes('prestasi')) return 'fas fa-star';
        if (label.includes('kerja') || label.includes('profesi')) return 'fas fa-briefcase';
        if (label.includes('catatan')) return 'fas fa-sticky-note';
        
        // Default Icon jika tidak ada yang cocok
        return 'fas fa-pen'; 
    }   

function renderUserForm(config) {
    const container = document.getElementById('dynamicFormFields'); 
    if(!container) return;
    
    if (!config || config.length === 0) { 
        container.innerHTML = '<div class="col-12 text-center text-muted">Belum ada formulir.</div>'; 
        return;
    }

    let html = '';
    config.forEach(field => {
        let reqAttr = field.required ? 'required' : ''; 
        let labelMark = field.required ? '<span class="text-danger">*</span>' : ''; 
        let inputElement = '';
        
        let iconClass = detectIcon(field.label);

        // Logic lebar kolom
        let colClass = field.width === 'one-fifth' ? 'col-md-one-fifth' : `col-md-${field.width}`;
        colClass += ' col-12'; 

        // Generate Element
        if (field.type === 'textarea') {
            inputElement = `<textarea class="form-control bg-light border-0" name="${field.label}" rows="3" ${reqAttr} placeholder="${field.label}"></textarea>`;
        } 
        else if (field.type === 'dropdown') { 
            let opts = field.options ? field.options.split(',').map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('') : ''; 
            inputElement = `<select class="form-select bg-light border-0" name="${field.label}" ${reqAttr}><option value="">- Pilih -</option>${opts}</select>`; 
        }
        else if (field.type === 'file') { 
            let safeId = field.label.replace(/[^a-zA-Z0-9]/g, ''); 
            
            // === PERBAIKAN DI SINI ===
            // 1. name="${field.label}" tetap ada.
            // 2. ${reqAttr} DIHAPUS dari dalam tag <input> agar tidak error "not focusable".
            inputElement = `
            <div class="upload-box p-3 bg-light border border-2 border-dashed rounded-3" onclick="document.getElementById('file-${safeId}').click()" style="cursor:pointer; transition:0.3s;">
                <div class="upload-icon text-primary mb-2"><i class="fas fa-cloud-upload-alt fa-2x"></i></div>
                <div class="small text-muted fw-bold" id="fname-${safeId}">Klik untuk upload ${field.label}</div>
                <div class="text-[10px] text-slate-400 mt-1">(Max 5MB â€¢ PDF/JPG)</div>
                
                <input type="file" id="file-${safeId}" name="${field.label}" hidden accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileCache(this, '${field.label}', '${safeId}')">
            </div>`;
            // =========================
        }
        else { 
            let inputType = field.type === 'number' ? 'number' : (field.type === 'date' ? 'date' : 'text');
            inputElement = `<input type="${inputType}" class="form-control bg-light border-0" name="${field.label}" placeholder="${field.label}" ${reqAttr}>`;
        }

        // Bungkus Layout
        if (field.type === 'file') {
             html += `
            <div class="${colClass} mb-4">
                <div class="form-group">
                    <label class="form-label small fw-bold text-secondary mb-2">${field.label} ${labelMark}</label>
                    ${inputElement}
                </div>
            </div>`;
        } else {
            html += `
            <div class="${colClass} mb-4">
                <div class="form-group">
                    <label class="form-label small fw-bold text-secondary mb-2">${field.label} ${labelMark}</label>
                    <div class="input-group shadow-sm" style="border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0;">
                        <span class="input-group-text bg-white border-0 text-primary px-3">
                            <i class="${iconClass}"></i>
                        </span>
                        ${inputElement}
                    </div>
                </div>
            </div>`;
        }
    }); 
    
    container.innerHTML = html;
}

    function handleFileCache(input, label, safeId) {
        const file = input.files[0]; const displayEl = document.getElementById(`fname-${safeId}`);
        if(file) { if (file.size > 5 * 1024 * 1024) { Swal.fire('Warning', 'Max 5MB', 'warning'); input.value = ''; return; }
        const reader = new FileReader(); reader.onload = e => { fileUploadCache[label] = { data: e.target.result.split(',')[1], type: file.type, name: file.name }; displayEl.innerHTML = `<b class="text-success">${file.name}</b>`; }; reader.readAsDataURL(file);
        } else { delete fileUploadCache[label]; displayEl.innerHTML = 'Klik upload (PDF/JPG)'; }
    }
// ==========================================
// HANDLE FORM SUBMIT (NEW & EDIT)
// ==========================================
function handleDynamicSubmit(e) {
    e.preventDefault();

    // ==========================================
    // 1. VALIDASI MANUAL FILE UPLOAD (BARU)
    // ==========================================
    // Karena atribut 'required' pada input file hidden kita hapus,
    // kita harus cek manual apakah user sudah upload file (jika wajib).
    
    let missingFiles = [];
    
    // Pastikan variabel global formConfig tersedia
    if(typeof formConfig !== 'undefined') {
        formConfig.forEach(field => {
            // Hanya cek jika tipe file DAN field tersebut required (wajib)
            if (field.type === 'file' && field.required) {
                
                // Cek apakah kita sedang dalam Mode Edit
                const editKodeInput = document.getElementById('editKodeInput');
                const isEditMode = editKodeInput && editKodeInput.value;
                
                // LOGIKA VALIDASI:
                // 1. Jika Pendaftaran Baru: File WAJIB ada di cache (fileUploadCache).
                // 2. Jika Mode Edit: File TIDAK WAJIB ada di cache (karena mungkin user pakai file lama).
                
                if (!isEditMode) {
                     if (!fileUploadCache[field.label]) {
                        missingFiles.push(field.label);
                     }
                }
            }
        });
    }

    // Jika ada file yang kurang, hentikan proses dan beri peringatan
    if (missingFiles.length > 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Berkas Belum Lengkap',
            html: `Mohon upload dokumen berikut sebelum mengirim:<br><br><b>${missingFiles.join('<br>')}</b>`
        });
        return; // STOP: Jangan lanjut ke pengiriman data
    }
    // ==========================================


    // 2. Kumpulkan Data dari Input Form
    let formData = {};
    const inputs = document.querySelectorAll('#dynamicFormFields [name]');
    
    inputs.forEach(el => {
        formData[el.name] = el.value;
    });

    // 3. Gabungkan dengan Data File Upload (Base64 dari Cache)
    Object.assign(formData, fileUploadCache);

    // 4. Cek Apakah Sedang dalam Mode Edit (Perbaikan Data)
    const editKodeInput = document.getElementById('editKodeInput');

    if (editKodeInput && editKodeInput.value) {
        // ========================================
        // A. LOGIKA UNTUK PERBAIKAN DATA (REVISI)
        // ========================================
        
        // Masukkan Kode Pendaftaran agar backend tahu data mana yang diupdate
        formData.kodePendaftaran = editKodeInput.value;

        Swal.fire({
            title: 'Mengirim Revisi...',
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Revisi Terkirim!',
                    text: 'Data Anda telah diperbarui dan status kembali menjadi Pending.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Reload halaman untuk membersihkan formulir dan keluar dari mode edit
                    window.location.reload();
                });
            } else {
                Swal.fire('Gagal Update', res.message, 'error');
            }
        }).submitPerbaikan(formData); // Memanggil fungsi backend khusus update

    } else {
        // ========================================
        // B. LOGIKA UNTUK PENDAFTARAN BARU
        // ========================================
        
        Swal.fire({
            title: 'Mengirim Data...',
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // Tampilkan Kode Pendaftaran
                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berhasil!',
                    html: `
                        <p>Data Anda berhasil disimpan.</p>
                        <div style="background:#f0f9ff; padding:15px; border-radius:10px; border:1px dashed #0284c7; margin-top:10px;">
                            <small>Kode Pendaftaran Anda:</small><br>
                            <b style="font-size: 1.6rem; color:#0284c7; letter-spacing:1px;">${res.kodePendaftaran}</b>
                        </div>
                        <p class="small text-muted mt-2">Simpan kode ini untuk mengecek status kelulusan.</p>
                    `,
                    confirmButtonText: 'Selesai'
                });

                // Reset Formulir & Cache
                e.target.reset();
                fileUploadCache = {};

                // Reset Tampilan Upload Box
                document.querySelectorAll('.upload-box').forEach(box => {
                    box.style.backgroundColor = '#f8fafc';
                    box.style.borderColor = '#cbd5e1';
                    const label = box.querySelector('.small');
                    if (label) label.innerHTML = 'Klik upload (PDF/JPG)';
                });

            } else {
                Swal.fire('Gagal Mendaftar', res.message, 'error');
            }
        }).savePendaftaran(formData); // Memanggil fungsi backend pendaftaran baru
    }
}
    function cekStatus() {
        const val = document.getElementById('cekInput').value; 
        if(!val) return Swal.fire('Info', 'Masukkan Kode Pendaftaran', 'info'); 
        
        Swal.showLoading();
        
        google.script.run.withSuccessHandler(res => { 
            Swal.close(); 
            const div = document.getElementById('hasilStatus'); 
            
            if(res.success) { 
                let badge = 'bg-secondary';
                if(res.data.status === 'Diterima') badge = 'bg-success';
                else if(res.data.status === 'Tidak Diterima') badge = 'bg-danger';
                else if(res.data.status === 'Perbaikan') badge = 'bg-warning text-dark';
                else badge = 'bg-info text-dark'; // Pending

                let html = `
                <div class="mt-4 p-4 bg-white border rounded shadow-sm text-start animate-fade-in-up">
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <h6 class="fw-bold">Hasil Pencarian</h6>
                        <span class="badge ${badge}">${res.data.status}</span>
                    </div>
                    <p class="mb-1">Nama: <b>${res.data.nama}</b></p>
                    <p class="mb-1">NISN: ${res.data.nisn}</p>
                    <div class="alert alert-light border mt-3 p-2">
                        <small class="fw-bold text-muted">Catatan Admin:</small><br>
                        <span class="text-danger small fst-italic">${res.data.catatanAdmin || '-'}</span>
                    </div>
                `;

                // --- TOMBOL PERBAIKAN (BARU) ---
                if(res.data.status === 'Perbaikan') {
                    html += `
                    <button class="btn btn-warning w-100 mt-2 fw-bold shadow-sm" onclick="loadEditMode('${res.data.kodePendaftaran}')">
                        <i class="fas fa-edit me-2"></i> Perbaiki / Lengkapi Data
                    </button>`;
                }
                // --------------------------------

                html += `</div>`;
                div.innerHTML = html;
                div.style.display = 'block'; 

            } else { 
                Swal.fire('Error', res.message, 'error'); 
            } 
        }).cekStatus(val);
    }

// ==========================================
    // FUNGSI PENTING: UPDATE TAMPILAN PUBLIC
    // ==========================================
    function applyPublicConfig(conf) {
        if(!conf) return;

        // 1. Navbar & Judul
        // Cari elemen navbar brand title
        const navBrandTitle = document.querySelector('.navbar-brand span:first-of-type');
        const navBrandSub = document.querySelector('.navbar-brand span:last-of-type');
        if(navBrandTitle) navBrandTitle.innerText = conf.appName || 'SPMB Online';
        if(navBrandSub) navBrandSub.innerText = conf.footerJudul || 'Sekolah Unggulan';

        // 2. Hero Section
        const heroBadge = document.querySelector('.hero-badge');
        if(heroBadge) heroBadge.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${conf.teksHero || 'Penerimaan Siswa Baru'}`;
        
        const heroTitle = document.querySelector('.hero-title');
        if(heroTitle) heroTitle.innerHTML = `${conf.heroBaris1 || 'Masa Depan'} <span style="color: var(--primary);">${conf.heroBaris2 || 'Dimulai Disini'}</span>`;
        
        const heroDesc = document.querySelector('.hero-desc');
        if(heroDesc) heroDesc.innerText = conf.heroSubteks || '';
        
        const heroImg = document.querySelector('.hero-img');
        if(heroImg && conf.heroImageUrl) heroImg.src = conf.heroImageUrl;

        // 3. Footer
        // Cari elemen h5 di footer
        const footerTitle = document.querySelector('footer h5.mb-0');
        if(footerTitle) footerTitle.innerText = conf.footerJudul || 'SPMB Sekolah';
        
        const footerDesc = document.querySelector('footer p.small');
        if(footerDesc) footerDesc.innerText = conf.footerAlamat || 'Alamat Sekolah';
        
        const footerCopy = document.querySelector('footer div[style*="border-top"]');
        if(footerCopy) footerCopy.innerText = conf.footerHakCipta || 'Â© 2025 Panitia SPMB';

        // 4. Update List Kontak di Footer
        const contactList = document.querySelector('footer .col-md-3.mb-4 ul');
        if(contactList) {
            contactList.innerHTML = `
              <li class="mb-2"><i class="fas fa-phone me-2"></i> ${conf.footerTelepon || '-'}</li>
              <li class="mb-2"><i class="fas fa-envelope me-2"></i> ${conf.footerEmail || '-'}</li>
              <li class="mb-2"><i class="fas fa-map-marker-alt me-2"></i> ${conf.footerAlamat || '-'}</li>
            `;
        }

        // 5. Update Alur (Step 1-4)
        const steps = document.querySelectorAll('.step-item');
        if(steps.length >= 4) {
            // Step 1
            if(conf.alur1_judul) steps[0].querySelector('h5').innerText = "1. " + conf.alur1_judul;
            if(conf.alur1_desc) steps[0].querySelector('p').innerText = conf.alur1_desc;
            // Step 2
            if(conf.alur2_judul) steps[1].querySelector('h5').innerText = "2. " + conf.alur2_judul;
            if(conf.alur2_desc) steps[1].querySelector('p').innerText = conf.alur2_desc;
            // Step 3
            if(conf.alur3_judul) steps[2].querySelector('h5').innerText = "3. " + conf.alur3_judul;
            if(conf.alur3_desc) steps[2].querySelector('p').innerText = conf.alur3_desc;
            // Step 4
            if(conf.alur4_judul) steps[3].querySelector('h5').innerText = "4. " + conf.alur4_judul;
            if(conf.alur4_desc) steps[3].querySelector('p').innerText = conf.alur4_desc;
        }

        // 6. Cek Status Pendaftaran (Matikan Tombol jika Ditutup)
        if(conf.pendaftaranStatus === 'ditutup') {
             // Cari tombol daftar
             const btnDaftar = document.querySelector('a[href="#daftar"]');
             if(btnDaftar) {
                 btnDaftar.classList.add('disabled', 'bg-secondary', 'border-secondary');
                 btnDaftar.innerHTML = 'Pendaftaran Ditutup <i class="fas fa-lock ms-2"></i>';
                 btnDaftar.style.pointerEvents = 'none'; // Matikan klik
             }
             // Sembunyikan Form
             const sectionDaftar = document.getElementById('daftar');
             if(sectionDaftar) {
                sectionDaftar.innerHTML = `
                <div class="container text-center py-5" data-aos="zoom-in">
                    <div class="p-5 bg-slate-100 rounded-2xl border border-slate-200">
                        <i class="fas fa-calendar-times text-4xl text-slate-400 mb-3"></i>
                        <h2 class="text-2xl font-bold text-slate-600">Mohon Maaf, Pendaftaran Sudah Ditutup.</h2>
                        <p class="text-slate-500">Silakan hubungi panitia untuk informasi lebih lanjut.</p>
                    </div>
                </div>`;
             }
        }
    }

// Fungsi Toggle Mobile (Lama)
    function toggleSidebar() { 
        document.getElementById("wrapper").classList.toggle("toggled");
    }

    // Fungsi Toggle Desktop (BARU)
    function toggleSidebarDesktop() {
        const wrapper = document.getElementById("wrapper");
        const btnIcon = document.getElementById("btnToggleDesktop");
        
        // Toggle class CSS
        wrapper.classList.toggle("desktop-collapsed");
        
        // Ubah Icon Tombol (Opsional, agar terlihat interaktif)
        if (wrapper.classList.contains("desktop-collapsed")) {
            // Jika tertutup, icon panah ke dalam (indent)
            if(btnIcon) {
                btnIcon.classList.remove("fa-outdent");
                btnIcon.classList.add("fa-indent");
            }
        } else {
            // Jika terbuka, icon panah ke luar (outdent)
            if(btnIcon) {
                btnIcon.classList.remove("fa-indent");
                btnIcon.classList.add("fa-outdent");
            }
        }
    }

// ==========================================
    // LOGIC FILTER & PAGINATION (BARU)
    // ==========================================

    // 1. Handle Search
    function handleSearch(keyword) {
        keyword = keyword.toLowerCase();
        
        filteredPendaftar = cachedPendaftar.filter(item => {
            const nama = (item.nama || '').toLowerCase();
            const nisn = (item.nisn || '').toLowerCase();
            const kode = (item.kodePendaftaran || '').toLowerCase();
            const status = (item.status || '').toLowerCase();
            
            return nama.includes(keyword) || 
                   nisn.includes(keyword) || 
                   kode.includes(keyword) ||
                   status.includes(keyword);
        });

        currentPage = 1; // Reset ke halaman 1 setiap kali search
        updatePagination();
    }

    // 2. Handle Change Entries (10, 25, 50, all)
    function changeEntries(val) {
        if (val === 'all') {
            itemsPerPage = filteredPendaftar.length > 0 ? filteredPendaftar.length : 1;
        } else {
            itemsPerPage = parseInt(val);
        }
        currentPage = 1;
        updatePagination();
    }

    // 3. Handle Change Page (Prev/Next)
    function changePage(direction) {
        const totalPages = Math.ceil(filteredPendaftar.length / itemsPerPage);
        
        if (direction === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (direction === 'next' && currentPage < totalPages) {
            currentPage++;
        }
        updatePagination();
    }

    // 4. Update Tampilan Tabel & Kontrol Paginasi
    function updatePagination() {
        // Hitung Index Slice
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedData = filteredPendaftar.slice(start, end);
        
        // Render Tabel
        renderTable(paginatedData);

        // Update Info Text (Menampilkan X sampai Y dari Z)
        const showStart = filteredPendaftar.length === 0 ? 0 : start + 1;
        const showEnd = end > filteredPendaftar.length ? filteredPendaftar.length : end;
        
        document.getElementById('showStart').innerText = showStart;
        document.getElementById('showEnd').innerText = showEnd;
        document.getElementById('showTotal').innerText = filteredPendaftar.length;
        document.getElementById('pageIndicator').innerText = `Page ${currentPage}`;

        // Disable/Enable Buttons
        const totalPages = Math.ceil(filteredPendaftar.length / itemsPerPage);
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage >= totalPages || totalPages === 0);
    }

// Fungsi untuk memuat Form Edit
// Fungsi Memuat Mode Edit (ANTI LOMPAT)
// ==========================================
// FUNGSI MEMUAT MODE EDIT (SUPPORT SPA)
// ==========================================
function loadEditMode(kode) {
    // 1. [PENTING] Pindah tampilan ke Section Daftar dulu
    // Ini wajib agar section menjadi visible (display: block) sebelum data dimuat
    switchPage('daftar');

    // 2. Tampilkan Loading (Tanpa returnFocus agar layar tidak lompat)
    Swal.fire({ 
        title: 'Memuat Data...', 
        text: 'Mengambil data dari server',
        allowOutsideClick: false,
        returnFocus: false, 
        didOpen: () => Swal.showLoading() 
    });
      
    // 3. Panggil Server
    google.script.run.withSuccessHandler(res => {
        Swal.close();
        
        if(!res.success) {
            // Jika gagal (misal data tidak ketemu), kembalikan user ke halaman status
            switchPage('status');
            return Swal.fire('Gagal', res.message, 'error');
        }
        
        // 4. Ubah Tampilan Judul Section
        const sectionDaftar = document.getElementById('daftar');
        sectionDaftar.querySelector('.section-title').innerText = "Perbaikan Data";
        sectionDaftar.querySelector('.section-subtitle').innerHTML = `
            <div class="alert alert-warning d-inline-block px-4 py-2 shadow-sm animate-pulse">
                <i class="fas fa-tools me-2"></i> Mode Perbaikan: <b>${kode}</b>
            </div>`;
        
        // 5. Setup Hidden Input (Untuk menyimpan Kode Pendaftaran)
        let form = document.getElementById('SPMBForm');
        let hiddenInput = document.getElementById('editKodeInput');
        if(!hiddenInput) {
           hiddenInput = document.createElement('input');
           hiddenInput.type = 'hidden';
           hiddenInput.id = 'editKodeInput';
           hiddenInput.name = 'kodePendaftaran'; 
           form.appendChild(hiddenInput);
        }
        hiddenInput.value = kode;
        
        // 6. ISI DATA LAMA KE DALAM FORM
        const dataLama = res.data;
        
        Object.keys(dataLama).forEach(key => {
           let inputEl = form.querySelector(`[name="${key}"]`);
           
           if(inputEl) {
              if(inputEl.type !== 'file') {
                 // Isi input teks/angka/tanggal
                 inputEl.value = dataLama[key];
                 // Beri highlight warna kuning agar user tahu ini data lama
                 inputEl.style.backgroundColor = "#fffbeb"; 
                 inputEl.style.borderColor = "#fcd34d";
              } 
              else {
                 // Logika khusus File Upload
                 let fileUrl = dataLama[key];
                 // Cek apakah url valid (berisi http/https)
                 if(fileUrl && typeof fileUrl === 'string' && fileUrl.includes('http')) {
                    inputEl.removeAttribute('required'); // Agar tidak wajib upload ulang

                    let uploadBox = inputEl.closest('.upload-box');
                    if(uploadBox) {
                        uploadBox.style.borderColor = '#198754'; 
                        uploadBox.style.backgroundColor = '#f0fff4';
                        
                        let labelSmall = uploadBox.querySelector('.small');
                        if(labelSmall) {
                            labelSmall.innerHTML = `
                                <div class="p-2">
                                    <span class="text-success fw-bold"><i class="fas fa-check-circle"></i> File Tersimpan</span><br>
                                    <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-success mt-2 fw-bold" onclick="event.stopPropagation()">
                                        <i class="fas fa-eye me-1"></i> Lihat Dokumen Sebelumnya
                                    </a>
                                    <div class="text-muted mt-2" style="font-size:11px">
                                        (Klik kotak ini <b>hanya jika</b> ingin mengganti dokumen)
                                    </div>
                                </div>
                            `;
                        }
                    }
                 }
              }
           }
        });
        
        // 7. Ubah Tombol Submit menjadi 'Simpan Perbaikan'
        const btnSubmit = form.querySelector('button[type="submit"]');
        if(btnSubmit) {
            btnSubmit.innerHTML = '<i class="fas fa-save me-2"></i> Simpan Perbaikan Data';
            btnSubmit.classList.remove('btn-primary-custom');
            btnSubmit.classList.add('btn-warning', 'text-dark', 'fw-bold', 'shadow-warning');
        }

        // 8. Scroll Halus ke Judul Form (Memastikan posisi pas di mata user)
        sectionDaftar.scrollIntoView({ behavior: 'smooth', block: 'start' });

    }).getDataForEdit(kode);
}
// ==========================================
// TAMBAHAN: Tutup Sidebar saat klik konten (Mobile)
// ==========================================
document.getElementById('page-content-wrapper').addEventListener('click', function(e) {
    const wrapper = document.getElementById('wrapper');
    
    // 1. Cek apakah layar sedang mode mobile (lebar < 992px)
    const isMobile = window.innerWidth < 992;
    
    // 2. Cek apakah sidebar sedang terbuka (memiliki class 'toggled')
    const isSidebarOpen = wrapper.classList.contains('toggled');
    
    // 3. Pastikan yang diklik BUKAN tombol hamburger itu sendiri
    // (Supaya tidak bentrok/double action jika user klik tombol toggle)
    const isToggleButton = e.target.closest('button[onclick="toggleSidebar()"]');

    if (isMobile && isSidebarOpen && !isToggleButton) {
        toggleSidebar(); // Panggil fungsi penutup sidebar
    }
});

// ==========================================
// FIX: AUTO CLOSE NAVBAR MOBILE (PUBLIC)
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    
    // 1. Ambil elemen Navbar dan Toggler
    const navBar = document.getElementById('navbarNav');
    const navToggler = document.querySelector('.navbar-toggler');
    
    // Pastikan elemen ada (untuk menghindari error di halaman admin)
    if (navBar && navToggler) {

        // 2. Fungsi Menutup Navbar
        const closeNavbar = () => {
            // Cek apakah navbar sedang terbuka (memiliki class 'show')
            if (navBar.classList.contains('show')) {
                // Gunakan fungsi native Bootstrap 5 untuk menutup (toggle)
                // Kita "click" tombol toggler-nya secara programatis agar animasi berjalan normal
                navToggler.click(); 
            }
        };

        // 3. Event Listener: Klik pada Menu Link
        // Target: Semua link navigasi DAN tombol Admin di dalam navbar
        const navLinks = navBar.querySelectorAll('.nav-link, .btn-admin-nav');
        
        navLinks.forEach((link) => {
            link.addEventListener('click', () => {
                closeNavbar(); // Tutup navbar saat menu diklik
            });
        });

        // 4. Event Listener: Klik di Luar Navbar (Body Content)
        document.addEventListener('click', (event) => {
            // Jika yang diklik BUKAN bagian dari navbar DAN BUKAN tombol toggler
            // Maka tutup navbar
            if (!navBar.contains(event.target) && !navToggler.contains(event.target)) {
                closeNavbar();
            }
        });
    }
});

// ==========================================
    // 9. SPA NAVIGATION LOGIC (NEW)
    // ==========================================
    
    function switchPage(pageId) {
        // 1. Sembunyikan semua section
        document.querySelectorAll('.spa-section').forEach(el => {
            el.classList.remove('active-section');
        });
        
        // 2. Tampilkan section target
        const target = document.getElementById(pageId);
        if(target) {
            target.classList.add('active-section');
            
            // Scroll otomatis ke paling atas (agar user merasa pindah halaman)
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 3. Update status aktif di Navbar
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active-menu');
            
            // Cek apakah link ini mengarah ke pageId yang diklik
            // Kita cek onclick attribute-nya mengandung nama pageId
            const onclickAttr = link.getAttribute('onclick');
            if(onclickAttr && onclickAttr.includes(`'${pageId}'`)) {
                link.classList.add('active-menu');
            }
        });
        
        // 4. Tutup Navbar Mobile jika sedang terbuka
        const navBar = document.getElementById('navbarNav');
        if (navBar && navBar.classList.contains('show')) {
            document.querySelector('.navbar-toggler').click();
        }
    }

// ==========================================
    // EXPORT EXCEL HANDLER
    // ==========================================
    function downloadExcelReport() {
        // 1. Security Check
        if (!ADMIN_TOKEN) {
            Swal.fire('Error', 'Sesi kadaluarsa, silakan login ulang.', 'error');
            return;
        }

        // 2. Loading UI
        Swal.fire({
            title: 'Sedang Mengexport...',
            text: 'Menyiapkan file Excel, mohon tunggu.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // 3. Request ke Server
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // 4. Download File Secara Otomatis
                // Membuat elemen link tersembunyi untuk memicu download
                const link = document.createElement('a');
                link.href = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + res.data;
                link.download = res.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Tutup Loading & Beri Notif Sukses
                Swal.close();
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
                });
                Toast.fire({ icon: 'success', title: 'Excel berhasil diunduh' });

            } else {
                Swal.fire('Gagal Export', res.message, 'error');
            }
        }).generateExcelReport(ADMIN_TOKEN);
    }
</script>
</body>
</html>